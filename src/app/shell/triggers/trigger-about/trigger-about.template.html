<div class="container" *ngIf="item">
    <section class="details">
        <div class="field" *ngIf="item.created_at">
            <label i18n="@@triggerCreatedAtLabel">Created:</label>
            <div class="value">{{ item.created_at * 1000 | dateFrom }}</div>
        </div>
        <div class="field" *ngIf="item.updated_at">
            <label i18n="@triggerUpdatedAtLabel">Updated:</label>
            <div class="value">{{ item.updated_at * 1000 | dateFrom }}</div>
        </div>
    </section>
    <hr />
    <div class="settings">
        <section>
            <div class="field">
                <label
                    for="driver"
                    matTooltip="System to use for available status variables and function calls"
                    i18n="@@triggerTemplateSystemLabel"
                    >Template System:
                </label>
                <item-search-field
                    name="system"
                    [query_fn]="query_fn"
                    [(ngModel)]="template_system"
                ></item-search-field>
            </div>
        </section>
        <header>
            <div class="action">
                <button mat-icon-button [disabled]="!template_system" (tapped)="addCondition()">
                    <app-icon [icon]="{ class: 'backoffice-plus' }"></app-icon>
                </button>
            </div>
            <div class="text"  i18n="@@triggerConditionsHeader">Conditions</div>
        </header>
        <section>
            <div
                class="list"
                *ngIf="comparisons.length || time_dependents.length; else no_conditions"
            >
                <div class="header" i18n="@@triggerComparisonLabel">Variable Comparison Condtions</div>
                <div class="group comparisons">
                    <div
                        class="item"
                        *ngFor="let comparison of comparisons"
                    >
                        <div class="handle"></div>
                        <div class="details">
                            {{ comparison.left | json }} {{ comparison.operator }} {{
                            comparison.right | json }}
                        </div>
                        <button
                            mat-icon-button
                            [disabled]="!template_system"
                            (tapped)="editCondition(comparison)"
                        >
                            <app-icon [icon]="{ class: 'backoffice-edit'}"></app-icon>
                        </button>
                        <button mat-icon-button (tapped)="confirmRemoveCondition(comparison)">
                            <app-icon [icon]="{ class: 'backoffice-trash'}"></app-icon>
                        </button>
                    </div>
                </div>
                <div class="header" i18n="@@triggerTimeLabel">Time Dependent Conditions</div>
                <div class="group time-dependents">
                    <div
                        class="item"
                        *ngFor="let time of time_dependents"
                    >
                        <div class="handle"></div>
                        <div class="details">
                            {{ time.type === 'at' ? 'At time' : 'CRON' }} {{ time.type === 'at' ?
                            time.time : time.cron }}
                        </div>
                        <button
                            mat-icon-button
                            [disabled]="!template_system"
                            (tapped)="editCondition(time)"
                        >
                            <app-icon [icon]="{ class: 'backoffice-edit'}"></app-icon>
                        </button>
                        <button mat-icon-button (tapped)="confirmRemoveCondition(time)">
                            <app-icon [icon]="{ class: 'backoffice-trash'}"></app-icon>
                        </button>
                    </div>
                </div>
            </div>
        </section>
        <header>
            <div class="action">
                <button mat-icon-button [disabled]="!template_system" (tapped)="addAction()">
                    <app-icon [icon]="{ class: 'backoffice-plus' }"></app-icon>
                </button>
            </div>
            <div class="text" i18n="@@triggerActionsHeader">Actions</div>
        </header>
        <section>
            <div class="list" *ngIf="functions.length || mailers.length; else no_actions">
                <div class="header" i18n="@@triggerFunctionsLabel">Function Call Actions</div>
                <div
                    class="group functions"
                    cdkDropList
                    (cdkDropListDropped)="confirmReorder('function', $event)"
                >
                    <div
                        class="item"
                        *ngFor="let action of functions"
                        cdkDrag
                    >
                        <div class="handle" cdkDragHandle>
                            <app-icon [icon]="{ class: 'backoffice-select-arrows'}"></app-icon>
                        </div>
                        <div class="details">
                            {{action.mod}}, {{ action.method }}({{ action.args | json }})
                        </div>
                        <button
                            mat-icon-button
                            [disabled]="!template_system"
                            (tapped)="editAction(action)"
                        >
                            <app-icon [icon]="{ class: 'backoffice-edit'}"></app-icon>
                        </button>
                        <button mat-icon-button (tapped)="confirmRemoveAction(action)">
                            <app-icon [icon]="{ class: 'backoffice-trash'}"></app-icon>
                        </button>
                        <div class="placeholder" *cdkDragPlaceholder></div>
                    </div>
                </div>
                <div class="header" i18n="@@triggerEmailsLabel">Email Actions</div>
                <div
                    class="group emails"
                    cdkDropList
                    (cdkDropListDropped)="confirmReorder('mailer', $event)"
                >
                    <div
                        class="item"
                        *ngFor="let action of mailers"
                        cdkDrag
                    >
                        <div class="handle" cdkDragHandle>
                            <app-icon [icon]="{ class: 'backoffice-select-arrows'}"></app-icon>
                        </div>
                        <div class="details">
                            <span [matTooltip]="action.emails | formatList" i18n="@@emailCountDisplay"
                                >{{ action.emails.length }} { action.emails.length, plural, =1 { Address } other { Addresses } }</span
                            >
                            | Body Length: {{ action.content.length }}
                        </div>
                        <button
                            mat-icon-button
                            [disabled]="!template_system"
                            (tapped)="editAction(action)"
                        >
                            <app-icon [icon]="{ class: 'backoffice-edit'}"></app-icon>
                        </button>
                        <button mat-icon-button (tapped)="confirmRemoveAction(action)">
                            <app-icon [icon]="{ class: 'backoffice-trash'}"></app-icon>
                        </button>
                        <div class="placeholder" *cdkDragPlaceholder></div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>
<ng-template #no_conditions>
    <div class="info-block">
        <div class="text" i18n="@@triggerConditionsEmpty">No condtions for trigger</div>
    </div>
</ng-template>
<ng-template #no_actions>
    <div class="info-block">
        <div class="text" i18n="@@triggerActionsEmpty">No actions for trigger</div>
    </div>
</ng-template>
