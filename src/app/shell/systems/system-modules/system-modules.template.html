<div class="container" *ngIf="item">
    <section class="select">
        <div class="dropdown">
            <item-search-field
                name="module"
                [query_fn]="query_fn"
                [exclude]="exclude_fn"
                [ngModel]="null"
                (ngModelChange)="new_module = $event.id"
            ></item-search-field>
        </div>
        <button mat-button [disabled]="!new_module" (click)="addModule()"  i18n="@@addExistingAction">
            Add existing
        </button>
        <button mat-button (click)="newModule()" i18n="@@newAction">Add new</button>
    </section>
    <ng-container *ngIf="item.id && item.modules && !hide_exec">
        <section class="exec">
            <h3 i18n="@@execHeader">Execute command</h3>
            <system-exec-field [system]="item" [refresh]="refresh_modules"></system-exec-field>
        </section>
    </ng-container>
    <section class="device-list">
        <h3 i18n="@@moduleListHeader">Module List</h3>
        <table *ngIf="devices && devices.length > 0">
            <thead>
                <td class="small"></td>
                <td class="small" i18n="@@moduleStateLabel">State</td>
                <td class="name" i18n="@@moduleNameLabel">Name</td>
                <td class="module" i18n="@@moduleClassLabel">Class</td>
                <td class="ip" i18n="@@moduleIpLabel">IP</td>
                <td class="small"></td>
            </thead>
            <tbody cdkDropList (cdkDropListDropped)="drop($event)">
                <tr
                    *ngFor="let device of (devices || [])"
                    [context-menu]="menu"
                    [offset_y]="-64"
                    (contextAction)="handleContextEvent($event, device)"
                    cdkDrag
                >
                    <td class="small">
                        <div class="action grab" cdkDragHandle>
                            <i class="backoffice-select-arrows"></i>
                        </div>
                    </td>
                    <td class="small">
                        <i
                            *ngIf="device && item.id"
                            binding
                            [(model)]="device.connected"
                            (modelChange)="refresh_modules = !refresh_modules"
                            [sys]="item.id"
                            [mod]="device_classes[device.id]"
                            bind="connected"
                        ></i>
                        <div
                            class="state"
                            [class.active]="device.running && !!device.connected"
                            [class.inactive]="device.running && !device.connected"
                            [class.black]="!device.running"
                            (click)="power(device)"
                        ></div>
                    </td>
                    <td class="name">
                        <a (contextmenu)="$event.stopPropagation()"
                            [routerLink]="['/modules', device.id]"
                            routerLinkActive="router-link-active" [matTooltip]="device.id"
                            >{{device.driver?.name || "&lt;Unnamed&gt;" }}</a
                        >
                    </td>
                    <td class="module">
                        <mat-checkbox
                            [checked]="debugged_modules[device.id]"
                            (click)="toggleDebugEvents(device)"
                        >
                            {{ device_classes[device.id] }}
                        </mat-checkbox>
                    </td>
                    <td class="ip">
                        <div class="lock">
                            <i class="backoffice-lock" *ngIf="device.tls"></i>
                        </div>
                        <a [href]="(device.tls ? 'https://' : 'http://') + device.ip"
                            >{{device.ip}}</a
                        >
                    </td>
                    <td class="duo" touchrelease>
                        <button mat-icon-button (click)="editModule(device)">
                            <app-icon
                                [icon]="{ class: 'backoffice-edit' }"
                            ></app-icon>
                        </button>
                        <button mat-icon-button [matMenuTriggerFor]="menu">
                            <app-icon
                                [icon]="{ class: 'backoffice-dots-three-vertical' }"
                            ></app-icon>
                        </button>
                        <mat-menu #menu="matMenu">
                            <button
                                mat-menu-item
                                *ngFor="let item of (device.running ? menu_options : offline_options)"
                                (click)="handleContextEvent(item, device)"
                            >
                                <app-icon [icon]="item.icon"></app-icon>
                                <div class="text">{{ item.name }}</div>
                            </button>
                        </mat-menu>
                    </td>
                    <td class="placeholder" colspan="6" *cdkDragPlaceholder></td>
                </tr>
            </tbody>
        </table>
        <div class="info-block" *ngIf="!devices || devices.length <= 0">
            <div class="text" i18n="@@moduleListEmpty">No devices for system</div>
        </div>
    </section>
</div>
