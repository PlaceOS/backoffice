"use strict";(self.webpackChunkbackoffice=self.webpackChunkbackoffice||[]).push([[206],{7206:(Et,L,l)=>{l.r(L),l.d(L,{AppSystemsModule:()=>pt});var u=l(6019),S=l(9010),b=l(3907),E=l(1540),P=l(1292),R=l(3083),m=l(4762),d=l(6605),M=l(4099),T=l(2372),B=l(5686),O=l(9204),f=l(8053),x=l(4102),$=l(739),z=l(9543),N=l(6133),w=l(2378),r=l(3829),j=l(5021),Q=l(129),H=l(1758),e=l(6079),U=l(2229);let h=(()=>{class n extends P.K{constructor(t,_,i){super(),this._state=t,this._debug=_,this._dialog=i,this.item=this._state.item,this._loading=new M.X({}),this._modules=new M.X([]),this._change=new M.X(0),this.associated_settings=this._state.all_item.pipe((0,B.b)(300),(0,O.w)(o=>o&&o instanceof d.G6j?(0,d.aPQ)(o.id):[])),this.counts=(0,T.aj)([this._state.all_item,this._change]).pipe((0,B.b)(300),(0,O.w)(o=>(0,m.mG)(this,void 0,void 0,function*(){const[a]=o;if(!(a&&a instanceof d.G6j))return{};this._loading.next(Object.assign(Object.assign({},this._loading.getValue()),{settings:!0}));const c=yield Promise.all([(0,d.vNE)(a.id).pipe((0,f.U)(p=>p.total)).toPromise(),(0,d.Eio)(a.id).toPromise()]),[g,C]=c;return this._loading.next(Object.assign(Object.assign({},this._loading.getValue()),{settings:!1})),{devices:a.modules.length,zones:a.zones.length,triggers:g,metadata:C.length}}))),this.modules=(0,T.aj)([this.item,this._change]).pipe((0,O.w)(o=>(0,m.mG)(this,void 0,void 0,function*(){const a=o[0];if(!(a&&a instanceof d.G6j))return[];this._loading.next(Object.assign(Object.assign({},this._loading.getValue()),{modules:!0}));const c=yield(0,d.Ne_)({control_system_id:a.id,complete:!0,limit:200}).pipe((0,f.U)(g=>g.data)).toPromise();return this._loading.next(Object.assign(Object.assign({},this._loading.getValue()),{modules:!1})),c.sort((g,C)=>a.modules.indexOf(g.id)-a.modules.indexOf(C.id)),this._modules.next(c),c})),(0,x.d)()),this.debug_state=this.modules.pipe((0,f.U)(o=>o.reduce((a,c)=>(a[c.id]=this._debug.isListening(c),a),{}))),this.module_bindings=this.modules.pipe((0,f.U)(o=>o.map(a=>`${a.custom_name||a.name||"Blank"}_${(0,R.U0)(o,a)}`)),(0,x.d)()),this.zones=this._state.item.pipe((0,O.w)(o=>(0,m.mG)(this,void 0,void 0,function*(){if(!(o&&o instanceof d.G6j))return[];this._loading.next(Object.assign(Object.assign({},this._loading.getValue()),{zones:!0}));const a=yield(0,d.Lx_)(o.id).pipe((0,f.U)(c=>c.data)).toPromise();return a.sort((c,g)=>o.zones.indexOf(c.id)-o.zones.indexOf(g.id)),this._loading.next(Object.assign(Object.assign({},this._loading.getValue()),{zones:!1})),a})),(0,x.d)()),this.triggers=(0,T.aj)([this.item,this._change]).pipe((0,O.w)(o=>(0,m.mG)(this,void 0,void 0,function*(){const[a]=o;if(!(a&&a instanceof d.G6j))return[];this._loading.next(Object.assign(Object.assign({},this._loading.getValue()),{triggers:!0}));const c=yield(0,d.vNE)(a.id).pipe((0,f.U)(g=>g.data)).toPromise();return this._loading.next(Object.assign(Object.assign({},this._loading.getValue()),{triggers:!1})),c})),(0,x.d)()),this.loading=this._loading.asObservable(),this.getModules=()=>this._modules.getValue()}get active_item(){return this._state.active_item||{}}startSystem(){return(0,m.mG)(this,void 0,void 0,function*(){const t=yield this.confirm({title:"Start system?",content:"Are you sure you want to start this system?<br>All stopped modules within the system will boot up.",icon:{type:"icon",class:"backoffice-controller-play"}});t&&t.reason&&(t.loading("Starting system..."),(yield(0,d.igg)(this.active_item.id).toPromise().catch(i=>((0,r.cB)(`Failed to start system: ${JSON.stringify(i.response||i.message||i)}`),i)))||(0,r.t5)("Successfully started system"),t.close())})}stopSystem(){return(0,m.mG)(this,void 0,void 0,function*(){const t=yield this.confirm({title:"Stop system?",content:"Are you sure you want to stop this system?<br>All modules will be immediately stopped regardless of any other systems they may be in.",icon:{type:"icon",class:"backoffice-controller-stop"}});t&&t.reason&&(t.loading("Stopping system..."),(yield(0,d.edN)(this.active_item.id).toPromise().catch(i=>((0,r.cB)(`Failed to stop system: ${JSON.stringify(i.response||i.message||i)}`),i)))||(0,r.t5)("Successfully stopped system"),t.close())})}toggleModuleDebug(t){!t||(this._debug.isListening(t)?this._debug.unbind(t):this._debug.bind(t,`${t.custom_name||t.name||"Blank"}_${(0,R.U0)(this._modules.getValue(),t)}`))}newModule(){return(0,m.mG)(this,void 0,void 0,function*(){const t=yield this._state.edit(new d.SQz({system:this.active_item,control_system_id:this.active_item.id})).catch(_=>null);!t||this.joinModule(t.id)})}editModule(t){return(0,m.mG)(this,void 0,void 0,function*(){yield this._state.edit(t).catch(_=>null),this._change.next(Date.now())})}selectTrigger(){return(0,m.mG)(this,void 0,void 0,function*(){const t=this._dialog.open(Q.f,{data:{service_name:"Triggers",query_fn:o=>(0,d.$Um)({q:o}).pipe((0,f.U)(a=>a.data))}}),_=yield Promise.race([t.componentInstance.event.pipe((0,$.P)(o=>"action"===o.reason)).toPromise(),t.afterClosed().toPromise()]);if(!_||!_.reason)return t.close();const i=yield this.addTrigger(t.componentInstance.item);return t.close(),this._change.next(Date.now()),i})}addTrigger(t){return(0,m.mG)(this,void 0,void 0,function*(){const _=yield(0,d.nq4)(this.active_item.id,{control_system_id:this.active_item.id,enabled:!0,important:!1,trigger_id:t.id}).toPromise();return this.timeout("change",()=>this._change.next(Date.now())),_})}editTrigger(t){return(0,m.mG)(this,void 0,void 0,function*(){if(this.item&&t){const _=this._dialog.open(j.K,{height:"auto",width:"auto",maxHeight:"calc(100vh - 2em)",maxWidth:"calc(100vw - 2em)",data:{item:t,name:"Trigger",save:c=>(0,d.dqJ)(c.id,c),external_save:!0}}),i=yield Promise.race([_.componentInstance.event.pipe((0,$.P)(c=>"action"===c.reason)).toPromise(),_.afterClosed().toPromise()]);if(!i||!i.reason)return;_.componentInstance.loading="Saving trigger settings...";const o=`${(0,d._ds)()}/systems/${this.active_item.id}/triggers/${t.id}`,a=yield(0,d.gzd)(o,i.metadata).toPromise().catch(c=>{throw(0,r.cB)(`Error updating trigger settings. Error: ${JSON.stringify(c.response||c.message||c)}`),c});return _.close(),a?((0,r.t5)("Successfully updated trigger settings."),this.timeout("change",()=>this._change.next(Date.now())),a):t}})}removeTrigger(t){return(0,m.mG)(this,void 0,void 0,function*(){const _=yield this.confirm({title:"Remove trigger",content:`<p>Are you sure you want remove trigger "${t.name}"?</p><p>Configuration will be updated <strong>immediately</strong>.</p>`,icon:{type:"icon",class:"backoffice-trash"}});!_||!_.reason||(yield(0,d.LfU)(this.active_item.id,t.id).toPromise().catch(i=>{throw _.close(),(0,r.cB)(`Error removing trigger ${t.id} from system. Error: ${i.statusText||i.message||i}`),i}),_.close(),(0,r.t5)("Successfully removed trigger from system."),this._change.next(Date.now()))})}reorderModules(t,_){return(0,m.mG)(this,void 0,void 0,function*(){const i=yield this.confirm({title:"Change order?",content:"Are you sure you want to change the module priority?<br>Settings will be updated immediately for the system.",icon:{type:"icon",class:"backoffice-layers"}});if(!i||!i.reason)return;i.loading("Updating module order...");const o=[...this.active_item.modules];(0,E.bA)(o,t,_);const a=yield(0,d.EQg)(this.active_item.id,Object.assign(Object.assign({},this.active_item),{modules:o})).toPromise().catch(c=>((0,r.cB)(`Failed to reorder system modules: ${JSON.stringify(c.response||c.message||c)}`),c));i.close(),a instanceof d.G6j&&((0,r.t5)("Successfully reordered system modules."),this._state.replaceItem(a))})}reorderZones(t,_){return(0,m.mG)(this,void 0,void 0,function*(){const i=yield this.confirm({title:"Change order?",content:"Are you sure you want to change the zone priority?<br>Settings will be updated immediately for the system.",icon:{type:"icon",class:"backoffice-layers"}});if(!i||!i.reason)return;i.loading("Updating zone order...");const o=[...this.active_item.zones];(0,E.bA)(o,t,_);const a=yield(0,d.EQg)(this.active_item.id,Object.assign(Object.assign({},this.active_item),{zones:o})).toPromise().catch(c=>((0,r.cB)(`Failed to reorder system zones: ${JSON.stringify(c.response||c.message||c)}`),c));a instanceof d.G6j&&((0,r.t5)("Successfully reordered system zones."),this._state.replaceItem(a)),i.close()})}joinModule(t){return(0,m.mG)(this,void 0,void 0,function*(){const _=yield(0,d.y_E)(this.active_item.id,t).toPromise().catch(i=>{(0,r.cB)(`Error adding module ${t} to system. Error: ${i.statusText||i.message||i}`)});!_||(this._state.replaceItem(_),(0,r.t5)("Successfully added module to system."),this._change.next(Date.now()))})}removeModule(t){return(0,m.mG)(this,void 0,void 0,function*(){const _=yield this.confirm({title:"Remove module?",content:`Remove ${t.driver_id} from this system?<br>If this is not used elsewhere the associated data will be removed immediately.`,icon:{type:"icon",class:"backoffice-trash"}});if(!_||!_.reason)return;const i=yield(0,d.zed)(this.active_item.id,t.id).toPromise().catch(o=>{(0,r.cB)(`Error removing module ${t.id} from system. Error: ${o.statusText||o.message||o}`)});_.close(),i&&(this._state.replaceItem(i),(0,r.t5)("Successfully removed module from system."))})}reloadModule(t){var _;return(0,m.mG)(this,void 0,void 0,function*(){const i=yield this.confirm({title:"Recompile module?",content:"New driver code will be loaded and the device settings will be reloaded.",icon:{type:"icon",class:"backoffice-install"}});!i||!i.reason||(i.loading("Recompiling and reloading driver..."),yield(0,d.qEr)((null===(_=t.driver)||void 0===_?void 0:_.id)||t.driver_id).toPromise().catch(o=>{throw(0,r.cB)(`Error removing module ${t.id} from system. Error: ${o.statusText||o.message||o}`),o}),(0,r.t5)("Successfully removed module from system."),i.close())})}addZones(t){return(0,m.mG)(this,void 0,void 0,function*(){const _=(0,N.Tw)([...this.active_item.zones,...t.map(o=>o.id)]),i=yield(0,d.EQg)(this.active_item.id,Object.assign(Object.assign({},this.active_item),{zones:_})).toPromise().catch(o=>{(0,r.cB)(`Error adding ${t.length} zone(s) to system. Error: ${o.statusText||o.message||o}`)});!i||(this._state.replaceItem(i),(0,r.t5)("Successfully added zone to system."))})}removeZone(t){return(0,m.mG)(this,void 0,void 0,function*(){const _=yield this.confirm({title:"Remove zone?",content:`<p>Are you sure you want remove zone "${t.name}" from the system?</p>Configuration will be updated immediately.`,icon:{type:"icon",class:"backoffice-trash"}});if(!_||!_.reason)return;const i=this.active_item.zones.filter(a=>a!==t.id),o=yield(0,d.EQg)(this.active_item.id,Object.assign(Object.assign({},this.active_item),{zones:i})).toPromise().catch(a=>{(0,r.cB)(`Error removing zone ${t.id} from system. Error: ${a.statusText||a.message||a}`)});_.close(),o&&(this._state.replaceItem(o),(0,r.t5)("Successfully removed zone from system."))})}toggleModulePower(t){return(0,m.mG)(this,void 0,void 0,function*(){yield(t.running?d.iAP:d.Dqv)(t.id).toPromise().catch(i=>{throw"string"==typeof i&&i.length<64?(0,r.cB)(i):(0,r.cB)(`Failed to ${t.running?"stop":"start"} module '${t.id}'.\nView Error?`,"View",()=>this.viewDetails(i)),i}),(0,r.t5)("Module successfully "+(t.running?"stopped":"started")),t.running=!t.running})}viewDetails(t){this._dialog.open(H.a,{data:{content:t}})}confirm(t){return(0,m.mG)(this,void 0,void 0,function*(){return(0,N._5)(t,this._dialog)})}}return n.\u0275fac=function(t){return new(t||n)(e.LFG(w.L),e.LFG(z.i),e.LFG(U.uw))},n.\u0275prov=e.Yz7({token:n,factory:n.\u0275fac,providedIn:"root"}),n})();var V=l(2016),W=l(2874);let ee=(()=>{class n extends P.K{constructor(t){super(),this._service=t,this.name="systems",this.tab_list=[]}get extensions(){return(0,R.fq)(this._service.active_item,this.name)}updateTabList(t){this.tab_list=[{id:"about",name:"About",icon:{class:"backoffice-info-with-circle"}},{id:"modules",name:"Modules",count:t.devices,icon:{class:"backoffice-tablet"}},{id:"zones",name:"Zones",count:t.zones,icon:{class:"backoffice-layers"}},{id:"triggers",name:"Triggers",count:t.triggers,icon:{class:"backoffice-stopwatch"}},{id:"metadata",name:"Metadata",count:t.metadata,icon:{class:"backoffice-gist"}},{id:"history",name:"Settings History",icon:{class:"backoffice-clock"}}].concat(this.extensions)}ngOnInit(){this.updateTabList({}),this.subscription("counts",this._service.counts.subscribe(t=>this.updateTabList(t)))}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(h))},n.\u0275cmp=e.Xpm({type:n,selectors:[["app-systems"]],features:[e.qOj],decls:3,vars:1,consts:[[1,"flex-1","flex-col","sm:flex-row","flex","h-full","w-full","relative"],["heading","Systems","name","systems",1,"absolute","top-0","left-0","h-12","w-full","sm:h-full","sm:static"],["name","system","route","systems",1,"flex-1","relative","mt-12","sm:mt-0","w-full","sm:w-1/2",3,"tabs"]],template:function(t,_){1&t&&(e.TgZ(0,"div",0),e._UZ(1,"sidebar",1),e._UZ(2,"item-display",2),e.qZA()),2&t&&(e.xp6(2),e.Q6J("tabs",_.tab_list))},directives:[V.k,W.s],styles:["sidebar[_ngcontent-%COMP%]{transition:height .3s}@media screen and (min-width: 640px){sidebar[_ngcontent-%COMP%]{width:20em!important}}"]}),n})();var v=l(86),te=l(2433),y=l(7964),Y=l(6835);function _e(n,s){if(1&n&&(e.TgZ(0,"div",11),e.TgZ(1,"label"),e.SDv(2,12),e.qZA(),e.TgZ(3,"div",13),e.TgZ(4,"a",14),e._uU(5),e.qZA(),e.qZA(),e.qZA()),2&n){const t=e.oxw();e.xp6(4),e.Q6J("href",null==t.item?null:t.item.support_url,e.LSH),e.xp6(1),e.Oqu(null==t.item?null:t.item.support_url)}}function ne(n,s){if(1&n&&(e.TgZ(0,"div",11),e.TgZ(1,"label"),e.SDv(2,15),e.qZA(),e.TgZ(3,"div",13),e._uU(4),e.qZA(),e.qZA()),2&n){const t=e.oxw();e.xp6(4),e.Oqu(null!=t.item&&t.item.bookable?"Yes":"No")}}function ie(n,s){if(1&n&&(e.TgZ(0,"a",18),e._uU(1),e.qZA()),2&n){const t=e.oxw(2);e.Q6J("href","mailto:"+(null==t.item?null:t.item.email),e.LSH),e.xp6(1),e.Oqu(null==t.item?null:t.item.email)}}function oe(n,s){if(1&n&&(e.TgZ(0,"div",11),e.TgZ(1,"label"),e.SDv(2,16),e.qZA(),e.YNc(3,ie,2,2,"a",17),e.qZA()),2&n){const t=e.oxw();e.xp6(3),e.Q6J("ngIf",null==t.item?null:t.item.email)}}function se(n,s){if(1&n&&(e.TgZ(0,"div",11),e.TgZ(1,"label"),e.SDv(2,19),e.qZA(),e.TgZ(3,"div",13),e._uU(4),e.qZA(),e.qZA()),2&n){const t=e.oxw();e.xp6(4),e.Oqu(null==t.item?null:t.item.capacity)}}function ae(n,s){if(1&n&&(e.TgZ(0,"div",11),e.TgZ(1,"label"),e.SDv(2,20),e.qZA(),e.TgZ(3,"div",13),e._uU(4),e.qZA(),e.qZA()),2&n){const t=e.oxw();e.xp6(4),e.Oqu(null==t.item?null:t.item.map_id)}}function ce(n,s){if(1&n&&(e.TgZ(0,"div",11),e.TgZ(1,"label"),e.SDv(2,21),e.qZA(),e.TgZ(3,"div",13),e._uU(4),e.qZA(),e.qZA()),2&n){const t=e.oxw();e.xp6(4),e.Oqu(null==t.item?null:t.item.installed_ui_devices)}}function le(n,s){if(1&n&&(e.TgZ(0,"div",11),e.TgZ(1,"label"),e.SDv(2,22),e.qZA(),e.TgZ(3,"div",13),e._uU(4),e.ALo(5,"dateFrom"),e.qZA(),e.qZA()),2&n){const t=e.oxw();e.xp6(4),e.Oqu(e.lcZ(5,1,1e3*(null==t.item?null:t.item.created_at)))}}function de(n,s){if(1&n&&(e.TgZ(0,"div",11),e.TgZ(1,"label"),e.SDv(2,23),e.qZA(),e.TgZ(3,"div",13),e._uU(4),e.ALo(5,"dateFrom"),e.qZA(),e.qZA()),2&n){const t=e.oxw();e.xp6(4),e.Oqu(e.lcZ(5,1,1e3*(null==t.item?null:t.item.updated_at)))}}const re=function(){return[]};function me(n,s){if(1&n&&(e.TgZ(0,"section"),e._UZ(1,"a-settings-form",24),e.ALo(2,"async"),e.qZA()),2&n){const t=e.oxw();e.xp6(1),e.Q6J("id",null==t.item?null:t.item.id)("merge",!0)("settings",null==t.item?null:t.item.settings)("merge_settings",e.lcZ(2,4,t.other_settings)||e.DdM(6,re))}}function Se(n,s){1&n&&(e.TgZ(0,"div",25),e._UZ(1,"mat-spinner",26),e.TgZ(2,"p"),e.SDv(3,27),e.qZA(),e.qZA()),2&n&&(e.xp6(1),e.Q6J("diameter",32))}let ge=(()=>{class n{constructor(t){this._service=t,this.other_settings=this._service.associated_settings,this.start=()=>this._service.startSystem(),this.stop=()=>this._service.stopSystem()}get item(){return this._service.active_item}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(h))},n.\u0275cmp=e.Xpm({type:n,selectors:[["system-about"]],decls:20,vars:10,consts:function(){let s,t,_,i,o,a,c,g,C,p,G,J;return s=$localize`:@@systemStartAction␟a0ad4d2f6db5011522b27a74a8a3f25fbcd91d05␟5385791890561823613: Start System `,t=$localize`:@@systemStopAction␟68db1b4a8dd3dfae41bbe41a32a4cbf32d44e077␟3926711479790873070: Stop System `,_=$localize`:@@settingsLabel␟121cc5391cd2a5115bc2b3160379ee5b36cd7716␟4930506384627295710:Settings`,i=$localize`:@@systemUrlLabel␟7e26fea74dd85099364f23205324001d5f08d729␟206794270698958656:Support URL:`,o=$localize`:@@systemBookableLabel␟1729892dec33ddc3daf35f197b6882eb1c4a8a1b␟238801422848943760:Bookable Room:`,a=$localize`:@@emailLabel␟31703f614ddd8547d63317830a59c0a7b935778e␟8507709425849513695:Email: `,c=$localize`:@@capacityLabel␟a1170e85d1897210d5fe03d1f363587de15d02cd␟8062822823331512246:Capacity:`,g=$localize`:@@mapIdLabel␟46a8087017d0d929ed6d398ba5d3a5ea1be7ab9b␟1613414518051599973:Map ID:`,C=$localize`:@@systemPanelCountLabel␟45b07d34ed29d3a5269b5bac86182781001845a9␟4375591254429334656:Installed Touch Panels:`,p=$localize`:@@systemCreatedAtLabel␟a5ed099ffc9e96f6970df843289ade8a7d20ab9f␟1616250945945379783:Created:`,G=$localize`:@systemUpdatedAtLabel␟f94240161f912dbd8758b858877cddeab80f36cb␟1116759395536210856:Updated:`,J=$localize`:@@systemLoadingLabel␟12761354f7c79edc553ff408524f5b791cd54481␟3385246531183416995:Loading system settings...`,[[1,"flex","items-center","space-x-2","mb-4"],["mat-button","",1,"flex-1","sm:flex-none",3,"click"],s,t,[1,"details"],["class","flex items-center space-x-2",4,"ngIf"],[1,"my-4"],[1,"font-medium","text-lg"],_,[4,"ngIf","ngIfElse"],["load_state",""],[1,"flex","items-center","space-x-2"],i,[1,"value"],["target","_blank",1,"underline",3,"href"],o,a,["class","underline select-all","target","_blank",3,"href",4,"ngIf"],["target","_blank",1,"underline","select-all",3,"href"],c,g,C,p,G,[3,"id","merge","settings","merge_settings"],[1,"flex","flex-col","p-8","items-center","justify-center"],[1,"mb-4",3,"diameter"],J]},template:function(t,_){if(1&t&&(e.TgZ(0,"section",0),e.TgZ(1,"button",1),e.NdJ("click",function(){return _.start()}),e.SDv(2,2),e.qZA(),e.TgZ(3,"button",1),e.NdJ("click",function(){return _.stop()}),e.SDv(4,3),e.qZA(),e.qZA(),e.TgZ(5,"section",4),e.YNc(6,_e,6,2,"div",5),e.YNc(7,ne,5,1,"div",5),e.YNc(8,oe,4,1,"div",5),e.YNc(9,se,5,1,"div",5),e.YNc(10,ae,5,1,"div",5),e.YNc(11,ce,5,1,"div",5),e.YNc(12,le,6,3,"div",5),e.YNc(13,de,6,3,"div",5),e.qZA(),e._UZ(14,"hr",6),e.TgZ(15,"header",7),e.SDv(16,8),e.qZA(),e.YNc(17,me,3,7,"section",9),e.YNc(18,Se,4,1,"ng-template",null,10,e.W1O)),2&t){const i=e.MAs(19);e.xp6(6),e.Q6J("ngIf",null==_.item?null:_.item.support_url),e.xp6(1),e.Q6J("ngIf",null==_.item?null:_.item.bookable),e.xp6(1),e.Q6J("ngIf",null==_.item?null:_.item.email),e.xp6(1),e.Q6J("ngIf",null==_.item?null:_.item.capacity),e.xp6(1),e.Q6J("ngIf",null==_.item?null:_.item.map_id),e.xp6(1),e.Q6J("ngIf",null==_.item?null:_.item.installed_ui_devices),e.xp6(1),e.Q6J("ngIf",null==_.item?null:_.item.created_at),e.xp6(1),e.Q6J("ngIf",null==_.item?null:_.item.updated_at),e.xp6(4),e.Q6J("ngIf",(null==_.item?null:_.item.settings)&&_.other_settings)("ngIfElse",i)}},directives:[v.lW,u.O5,te.v,y.$g],pipes:[Y.R,u.Ov],styles:["[_nghost-%COMP%]{padding:1rem;height:100%;width:100%}button[_ngcontent-%COMP%]{min-width:8rem}"]}),n})();var ue=l(6555),D=l(3100),pe=l(9688),Ee=l(3045),F=l(9499),X=l(2324),fe=l(904),K=l(7444),I=l(3530);function Ae(n,s){if(1&n&&(e.TgZ(0,"section",14),e.TgZ(1,"h3",11),e.SDv(2,15),e.qZA(),e._UZ(3,"execute-method-field",16),e.qZA()),2&n){const t=e.oxw(2);e.xp6(3),e.Q6J("system",t.item)}}function Ce(n,s){1&n&&e._UZ(0,"div",54)}function Me(n,s){if(1&n&&(e.TgZ(0,"div",55),e._uU(1),e.qZA()),2&n){const t=e.oxw().$implicit;e.xp6(1),e.hij(" ",t.notes," ")}}function Te(n,s){1&n&&e._UZ(0,"app-icon",56)}function Oe(n,s){if(1&n){const t=e.EpF();e.TgZ(0,"button",57),e.NdJ("click",function(){const o=e.CHM(t).$implicit,a=e.oxw().$implicit;return e.oxw(4).handleContextEvent(o,a)}),e._UZ(1,"app-icon",50),e.TgZ(2,"div",58),e._uU(3),e.qZA(),e.qZA()}if(2&n){const t=s.$implicit;e.xp6(1),e.Q6J("icon",t.icon),e.xp6(2),e.hij(" ",t.name," ")}}const he=function(n){return["/modules",n]},ve=function(){return{class:"backoffice-edit"}},ye=function(){return{class:"backoffice-dots-three-vertical"}};function be(n,s){if(1&n){const t=e.EpF();e.TgZ(0,"div",33),e.NdJ("contextAction",function(i){const a=e.CHM(t).$implicit;return e.oxw(4).handleContextEvent(i,a)}),e.YNc(1,Ce,1,0,"div",34),e.TgZ(2,"div",35),e._UZ(3,"app-icon",36),e.qZA(),e.TgZ(4,"div",37),e.TgZ(5,"div",38),e.NdJ("modelChange",function(i){return e.CHM(t).$implicit.connected=i})("click",function(){const o=e.CHM(t).$implicit;return e.oxw(4).power(o)}),e.ALo(6,"async"),e.qZA(),e.qZA(),e.TgZ(7,"div",39),e.TgZ(8,"a",40),e.NdJ("contextmenu",function(i){return i.stopPropagation()}),e._uU(9),e.qZA(),e.YNc(10,Me,2,1,"div",41),e.qZA(),e.TgZ(11,"div",25),e.TgZ(12,"span",42),e.ALo(13,"async"),e._uU(14),e.ALo(15,"async"),e.qZA(),e.qZA(),e.TgZ(16,"div",43),e.YNc(17,Te,1,0,"app-icon",44),e.TgZ(18,"a",45),e._uU(19),e.qZA(),e.qZA(),e.TgZ(20,"div",46),e.TgZ(21,"mat-checkbox",47),e.NdJ("change",function(){const o=e.CHM(t).$implicit;return e.oxw(4).toggleDebug(o)}),e.ALo(22,"async"),e.ALo(23,"async"),e.qZA(),e.qZA(),e.TgZ(24,"div",48),e.TgZ(25,"button",49),e.NdJ("click",function(){const o=e.CHM(t).$implicit;return e.oxw(4).editModule(o)}),e._UZ(26,"app-icon",50),e.qZA(),e.TgZ(27,"button",51),e._UZ(28,"app-icon",50),e.qZA(),e.TgZ(29,"mat-menu",null,52),e.YNc(31,Oe,4,2,"button",53),e.qZA(),e.qZA(),e.qZA()}if(2&n){const t=s.$implicit,_=s.index,i=e.MAs(30),o=e.oxw(4);e.Q6J("context-menu",i),e.xp6(5),e.ekj("bg-black",!t.running)("bg-error",t.running&&!t.connected)("bg-success",t.running&&!!t.connected),e.Q6J("sys",o.item.id)("mod",e.lcZ(6,26,o.bindings)[_])("model",t.connected),e.xp6(3),e.Q6J("routerLink",e.VKq(36,he,t.id))("title",(null==t.driver?null:t.driver.name)||"<Unnamed>"),e.xp6(1),e.hij(" ",(null==t.driver?null:t.driver.name)||"<Unnamed>"," "),e.xp6(1),e.Q6J("ngIf",t.notes),e.xp6(2),e.Q6J("title",e.lcZ(13,28,o.bindings)[_]),e.xp6(2),e.Oqu(e.lcZ(15,30,o.bindings)[_]),e.xp6(3),e.Q6J("ngIf",t.tls),e.xp6(1),e.Q6J("href",t.ip?(t.tls?"https://":"http://")+t.ip:t.uri,e.LSH),e.xp6(1),e.Oqu(t.ip||t.uri),e.xp6(2),e.Q6J("disabled",!t.running)("checked",e.lcZ(22,32,o.debugging)[t.id])("matTooltip",(e.lcZ(23,34,o.debugging)[t.id]?"Disable":"Enable")+" Debugging"),e.xp6(5),e.Q6J("icon",e.DdM(38,ve)),e.xp6(1),e.Q6J("matMenuTriggerFor",i),e.xp6(1),e.Q6J("icon",e.DdM(39,ye)),e.xp6(3),e.Q6J("ngForOf",t.running?o.menu_options:o.offline_options)}}function Pe(n,s){if(1&n){const t=e.EpF();e.TgZ(0,"div",18),e.TgZ(1,"div",19),e._UZ(2,"div",20),e.TgZ(3,"div",21),e.SDv(4,22),e.qZA(),e.TgZ(5,"div",23),e.SDv(6,24),e.qZA(),e.TgZ(7,"div",25),e.SDv(8,26),e.qZA(),e.TgZ(9,"div",25),e.SDv(10,27),e.qZA(),e.TgZ(11,"div",28),e.SDv(12,29),e.qZA(),e._UZ(13,"div",30),e.qZA(),e.TgZ(14,"div",31),e.NdJ("cdkDropListDropped",function(i){return e.CHM(t),e.oxw(3).drop(i)}),e.YNc(15,be,32,40,"div",32),e.ALo(16,"async"),e.qZA(),e.qZA()}if(2&n){const t=e.oxw(3);e.xp6(15),e.Q6J("ngForOf",e.lcZ(16,1,t.modules))}}function xe(n,s){if(1&n&&(e.ynx(0),e.YNc(1,Pe,17,3,"div",17),e.ALo(2,"async"),e.BQk()),2&n){const t=e.oxw(2),_=e.MAs(4);let i;e.xp6(1),e.Q6J("ngIf",null==(i=e.lcZ(2,2,t.modules))?null:i.length)("ngIfElse",_)}}function Ne(n,s){if(1&n){const t=e.EpF();e.ynx(0),e.TgZ(1,"section",3),e.TgZ(2,"item-search-field",4),e.NdJ("ngModelChange",function(i){return e.CHM(t),e.oxw().new_module=i.id}),e.qZA(),e.TgZ(3,"button",5),e.NdJ("click",function(){return e.CHM(t),e.oxw().addModule()}),e.SDv(4,6),e.qZA(),e.TgZ(5,"button",7),e.NdJ("click",function(){return e.CHM(t),e.oxw().newModule()}),e.SDv(6,8),e.qZA(),e.qZA(),e.YNc(7,Ae,4,1,"section",9),e.TgZ(8,"section",10),e.TgZ(9,"h3",11),e.SDv(10,12),e.qZA(),e.YNc(11,xe,3,4,"ng-container",13),e.ALo(12,"async"),e.qZA(),e.BQk()}if(2&n){const t=e.oxw(),_=e.MAs(2);e.xp6(2),e.Q6J("query_fn",t.query_fn)("exclude",t.exclude_fn)("ngModel",null),e.xp6(1),e.Q6J("disabled",!t.new_module),e.xp6(4),e.Q6J("ngIf",t.item.id&&t.item.modules&&!t.hide_exec),e.xp6(4),e.Q6J("ngIf",!e.lcZ(12,7,t.loading).modules)("ngIfElse",_)}}function Fe(n,s){1&n&&(e.TgZ(0,"div",59),e._UZ(1,"mat-spinner",60),e.TgZ(2,"p"),e._uU(3,"Loading modules..."),e.qZA(),e.qZA()),2&n&&(e.xp6(1),e.Q6J("diameter",48))}function Ze(n,s){1&n&&(e.TgZ(0,"div",59),e.TgZ(1,"p"),e._uU(2,"No devices for system"),e.qZA(),e.qZA())}let Re=(()=>{class n extends P.K{constructor(t,_){super(),this._service=t,this._dialog=_,this.device_listener={},this.loading=this._service.loading,this.modules=this._service.modules,this.debugging=this._service.debug_state,this.bindings=this._service.module_bindings,this.menu_options=[{id:"power",name:"Toggle Power",icon:{type:"icon",class:"backoffice-power-plug"}},{id:"state",name:"View State",icon:{type:"icon",class:"backoffice-eye"}},{id:"reload",name:"Recompile Driver",icon:{type:"icon",class:"backoffice-cw"}},{id:"edit",name:"Edit Module",icon:{type:"icon",class:"backoffice-edit"}},{id:"remove",name:"Remove Module",icon:{type:"icon",class:"backoffice-trash"}},{id:"load",name:"Load Module",icon:{type:"icon",class:"backoffice-arrow-with-circle-up"}}],this.offline_options=[{id:"power",name:"Toggle Power",icon:{type:"icon",class:"backoffice-power-plug"}},{id:"edit",name:"Edit Module",icon:{type:"icon",class:"backoffice-edit"}},{id:"remove",name:"Remove Module",icon:{type:"icon",class:"backoffice-trash"}},{id:"load",name:"Load Module",icon:{type:"icon",class:"backoffice-arrow-with-circle-up"}}],this.query_fn=i=>(0,d.Ne_)({q:i}).pipe((0,f.U)(o=>o.data.map(a=>{var c;return Object.assign(Object.assign({},a),{extra:null===(c=a.driver)||void 0===c?void 0:c.name})}))),this.exclude_fn=i=>i.control_system_id===this.item.id||i.role===d.TAy.Logic,this.newModule=()=>this._service.newModule(),this.removeModule=i=>this._service.removeModule(i),this.editModule=i=>this._service.editModule(i),this.joinModule=i=>this._service.joinModule(i),this.reloadModule=i=>this._service.reloadModule(i),this.toggleDebug=i=>this._service.toggleModuleDebug(i),this.power=i=>{this._service.toggleModulePower(i),this.refresh_modules=!this.refresh_modules}}get item(){return this._service.active_item}handleContextEvent(t,_){if(t)switch(t.id){case"power":this.power(_);break;case"state":this.viewState(_);break;case"reload":this.reloadModule(_);break;case"remove":this.removeModule(_);break;case"load":this.loadModule(_);break;case"edit":this.editModule(_)}}reload(t){return(0,m.mG)(this,void 0,void 0,function*(){const _=yield(0,d.P8j)(t.id).toPromise();for(const i in _)_.hasOwnProperty(i)&&(t[i]=_[i])})}viewState(t){return(0,m.mG)(this,void 0,void 0,function*(){const _=this._service.getModules();this._dialog.open(ue.W,{data:{system:this.item,module:t,devices:_}})})}loadModule(t){(0,d.$yY)(t.id).toPromise().then(()=>(0,r.t5)(`Successfully loaded module "${t.name||t.id}"`),_=>(0,r.cB)(`Error loading module. Error: ${JSON.stringify(_.response||_.message||_)}`))}drop(t){t&&t.previousIndex!==t.currentIndex&&this._service.reorderModules(t.previousIndex,t.currentIndex)}addModule(){!this.new_module||(this.joinModule(this.new_module),this.new_module="")}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(h),e.Y36(U.uw))},n.\u0275cmp=e.Xpm({type:n,selectors:[["system-modules"]],features:[e.qOj],decls:5,vars:1,consts:function(){let s,t,_,i,o,a,c,g,C;return s=$localize`:@@addExistingAction␟8f50eee9d9b0eebaeadd97255bc3e5dc1f095c30␟4161166080314782574: Add existing `,t=$localize`:@@newAction␟1f048f39d0b8565dc14a060ab7fa746e7f780f84␟778924775597593118: Add new `,_=$localize`:@@moduleListHeader␟e8eea559e7b48b6744ba5b97a5c7d4ee27ff7b4d␟2210018937903105246: Module List `,i=$localize`:@@execHeader␟9871d8fa856ba440ac531210821716ee279c9327␟2605526423196683591: Execute command `,o=$localize`:@@moduleStateLabel␟1fe7f352e3bc7356c77226a4d8404ee498b0c9e3␟4221055628112420738: State `,a=$localize`:@@moduleNameLabel␟0da9e5314dbb425c214c88ca2b0449f57c4ec264␟8751673256360811138: Name `,c=$localize`:@@moduleClassLabel␟854f0df0f6dd52d4c28d575977c6e7bd641e8458␟2482335949657196140: Class `,g=$localize`:@@moduleIpLabel␟e80fa953f9bca955499cd79cc853b0e1fd51cb32␟4332685056058298852: IP/URI `,C=$localize`:@@moduleStateLabel␟fc83a662146f8a30bed7c588fc57842492e04140␟2901515939360038365: Debug `,[[4,"ngIf"],["load_state",""],["empty_state",""],["add-module","",1,"flex","space-x-2","flex-wrap","mb-2"],["name","module",1,"flex-grow-1","w-full","sm:flex-1","sm:w-auto","h-12",3,"query_fn","exclude","ngModel","ngModelChange"],["mat-button","",1,"flex-1","w-40","sm:w-32","sm:flex-none","h-11",3,"disabled","click"],s,["mat-button","",1,"flex-1","w-40","sm:w-32","sm:flex-none","h-11",3,"click"],t,["exec","","class","mb-2",4,"ngIf"],["device-list",""],[1,"font-medium","text-lg","mb-2"],_,[4,"ngIf","ngIfElse"],["exec","",1,"mb-2"],i,[3,"system"],["role","table","class","overflow-x-auto",4,"ngIf","ngIfElse"],["role","table",1,"overflow-x-auto"],["table-head",""],[1,"w-10","p-2"],[1,"w-12","p-2"],o,[1,"flex-1","p-2"],a,[1,"w-48","p-2"],c,g,[1,"w-[3.5rem]","p-2"],C,[1,"w-24","p-2","h-9"],["body","","cdkDropList","",1,"overflow-y-auto",3,"cdkDropListDropped"],["table-row","","cdkDrag","",3,"context-menu","contextAction",4,"ngFor","ngForOf"],["table-row","","cdkDrag","",3,"context-menu","contextAction"],["class","w-full h-10 border-2 border-dashed border-gray-600 bg-gray-300 bg-opacity-25",4,"cdkDragPlaceholder"],[1,"w-10","flex","justify-center","h-full",2,"cursor","grab"],["className","backoffice-select-arrows","cdkDragHandle",""],[1,"w-12","flex","items-center","justify-center","p-2","h-full"],["dot","","binding","","bind","connected",1,"h-4","w-4","rounded-full",3,"sys","mod","model","modelChange","click"],[1,"flex-1","p-2","h-full","flex","flex-col","justify-center"],[1,"truncate","underline","w-full",3,"routerLink","title","contextmenu"],["class","text-xs truncate w-full",4,"ngIf"],[1,"truncate",3,"title"],[1,"w-48","text-right","flex","items-center","h-full","p-2"],["className","backoffice-lock",4,"ngIf"],["target","_blank",1,"truncate","underline",3,"href"],[1,"w-[3.5rem]","flex","items-center","justify-center","p-2","h-full"],["matTooltipPosition","left",3,"disabled","checked","matTooltip","change"],[1,"w-24","flex","px-2","justify-center"],["mat-icon-button","",3,"click"],[3,"icon"],["mat-icon-button","",3,"matMenuTriggerFor"],["menu","matMenu"],["mat-menu-item","",3,"click",4,"ngFor","ngForOf"],[1,"w-full","h-10","border-2","border-dashed","border-gray-600","bg-gray-300","bg-opacity-25"],[1,"text-xs","truncate","w-full"],["className","backoffice-lock"],["mat-menu-item","",3,"click"],[1,"text"],[1,"flex","flex-col","items-center","p-8","mx-auto"],[1,"mb-4",3,"diameter"]]},template:function(t,_){1&t&&(e.YNc(0,Ne,13,9,"ng-container",0),e.YNc(1,Fe,4,1,"ng-template",null,1,e.W1O),e.YNc(3,Ze,3,0,"ng-template",null,2,e.W1O)),2&t&&e.Q6J("ngIf",_.item)},directives:[u.O5,D.y,S.JJ,S.On,v.lW,pe.Q,E.Wj,u.sg,E.Zt,Ee.G,E.Hk,F.o,E.Bh,X.D,b.yS,fe.oG,K.gM,I.p6,I.VK,I.OP,y.$g],pipes:[u.Ov],styles:["[_nghost-%COMP%]{padding:1rem}button[mat-button][_ngcontent-%COMP%]{min-width:8rem}button.mat-menu-item[_ngcontent-%COMP%]{display:flex;align-items:center}button[_ngcontent-%COMP%]   .text[_ngcontent-%COMP%]{margin-left:1rem}[role=table][_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{width:100%;min-width:48rem}.bg-success[_ngcontent-%COMP%]{height:.5rem!important;width:.5rem!important}[dot][_ngcontent-%COMP%]{transition:height .2s,width .2s}mat-checkbox.mat-checkbox-disabled[_ngcontent-%COMP%]{pointer-events:none}"]}),n})();var k=l(8167),Ue=l(138);const Ie=function(n){return["/triggers",n]};function Le(n,s){if(1&n){const t=e.EpF();e.TgZ(0,"div",22),e.TgZ(1,"i",23),e.NdJ("modelChange",function(i){const a=e.CHM(t).$implicit;return e.oxw(3).trigger_state[a.id]=i})("modelChange",function(){const o=e.CHM(t).$implicit;return e.oxw(3).updateComparisons(o.id)}),e.qZA(),e.TgZ(2,"div",24),e._UZ(3,"div",25),e.qZA(),e.TgZ(4,"div",12),e.TgZ(5,"a",26),e._uU(6),e.qZA(),e.qZA(),e.TgZ(7,"div",27),e._uU(8),e.qZA(),e.TgZ(9,"div",27),e._uU(10),e.qZA(),e.TgZ(11,"div",28),e._uU(12),e.ALo(13,"dateFrom"),e.qZA(),e.TgZ(14,"div",29),e.TgZ(15,"button",30),e.NdJ("click",function(){const o=e.CHM(t).$implicit;return e.oxw(3).copyWebhookURL(o)}),e._UZ(16,"app-icon",31),e.qZA(),e.TgZ(17,"button",30),e.NdJ("click",function(){const o=e.CHM(t).$implicit;return e.oxw(3).editTrigger(o)}),e._UZ(18,"app-icon",32),e.qZA(),e.TgZ(19,"button",30),e.NdJ("click",function(){const o=e.CHM(t).$implicit;return e.oxw(3).deleteTrigger(o)}),e._UZ(20,"app-icon",33),e.qZA(),e.qZA(),e.qZA()}if(2&n){const t=s.$implicit,_=e.oxw(3);e.xp6(1),e.Q6J("sys",_.item.id)("bind",t.id)("model",_.trigger_state[t.id]),e.xp6(2),e.ekj("bg-black",!(null!=_.trigger_state[t.id]&&_.trigger_state[t.id].triggered))("bg-success",null==_.trigger_state[t.id]?null:_.trigger_state[t.id].triggered),e.xp6(2),e.Q6J("routerLink",e.VKq(14,Ie,t.id)),e.xp6(1),e.Oqu(t.name),e.xp6(2),e.hij(" ",null==_.trigger_state[t.id]?null:_.trigger_state[t.id].trigger_count," "),e.xp6(2),e.hij(" ",(null==_.trigger_state[t.id]?null:_.trigger_state[t.id].action_errors)+(null==_.trigger_state[t.id]?null:_.trigger_state[t.id].comparison_errors)||"0"," "),e.xp6(2),e.hij(" ",e.lcZ(13,12,1e3*+t.created_at)," ")}}function Be(n,s){if(1&n&&(e.TgZ(0,"div",9),e.TgZ(1,"div",10),e._UZ(2,"div",11),e.TgZ(3,"div",12),e.SDv(4,13),e.qZA(),e.TgZ(5,"div",14),e.SDv(6,15),e.qZA(),e.TgZ(7,"div",14),e.SDv(8,16),e.qZA(),e.TgZ(9,"div",17),e.SDv(10,18),e.qZA(),e._UZ(11,"div",19),e.qZA(),e.TgZ(12,"div",20),e.YNc(13,Le,21,16,"div",21),e.ALo(14,"async"),e.qZA(),e.qZA()),2&n){const t=e.oxw(2);e.xp6(13),e.Q6J("ngForOf",e.lcZ(14,1,t.triggers))}}function $e(n,s){if(1&n&&(e.ynx(0),e.YNc(1,Be,15,3,"div",8),e.ALo(2,"async"),e.BQk()),2&n){const t=e.oxw(),_=e.MAs(12);let i;e.xp6(1),e.Q6J("ngIf",null==(i=e.lcZ(2,2,t.triggers))?null:i.length)("ngIfElse",_)}}function we(n,s){1&n&&(e.TgZ(0,"div",34),e._UZ(1,"mat-spinner",35),e.TgZ(2,"p"),e._uU(3,"Loading triggers..."),e.qZA(),e.qZA()),2&n&&(e.xp6(1),e.Q6J("diameter",48))}function Ye(n,s){1&n&&(e.TgZ(0,"div",34),e.TgZ(1,"p"),e._uU(2,"No triggers for system"),e.qZA(),e.qZA())}let De=(()=>{class n{constructor(t){this._service=t,this.filter$=new M.X(""),this.loading=this._service.loading,this.trigger_state={},this.comparisons={},this.temp_trigger=new M.X(null),this.triggers=(0,T.aj)([this.filter$,this._service.triggers,this.temp_trigger]).pipe((0,f.U)(([_,i,o])=>{const a=_.toLowerCase(),c=(0,N.Tw)(o?[...i,o]:i,"id");return _?c.filter(g=>g.name.toLowerCase().includes(a)):c})),this.copyWebhookURL=_=>{(0,N.vQ)(`${location.origin}/api/engine/v2/webhook/${_.id}/notify?secret=${_.webhook_secret}`),(0,r.QD)("Webhook link copied to clipboard")},this.editTrigger=_=>(0,m.mG)(this,void 0,void 0,function*(){return this.temp_trigger.next(yield this._service.editTrigger(_))}),this.deleteTrigger=_=>this._service.removeTrigger(_),this.selectTrigger=()=>(0,m.mG)(this,void 0,void 0,function*(){return this.temp_trigger.next((yield this._service.selectTrigger())||null)})}get item(){return this._service.active_item}updateComparisons(t){if(this.comparisons[t]="",this.trigger_state[t])for(const _ in this.trigger_state[t].conditions)this.trigger_state[t].conditions.hasOwnProperty(_)&&(this.comparisons[t]&&(this.comparisons[t]+="\n"),this.comparisons[t]+=`${_}: ${this.trigger_state[t].conditions[_]}`)}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(h))},n.\u0275cmp=e.Xpm({type:n,selectors:[["system-triggers"]],decls:13,vars:5,consts:function(){let s,t,_,i;return s=$localize`:@@nameLabel␟851d1ba79a56f7143fc04dbfed912dd2e40af5a9␟5635653058319830659: Name `,t=$localize`:@@triggerCountLabel␟d0ea4c946d36271ef5a7eea211009023e2889b7d␟3931882206009909445: Count `,_=$localize`:@@triggerErrorsLabel␟1fce9d65748a6c97d279c89a0fdbae43bbc57720␟966064976086561720: Errors `,i=$localize`:@@descriptionLabel␟f1b6540744a5b8ea6596fb6aad63773e1e57474c␟5939856475984736508: Added `,[[1,"flex","items-center","mb-4","space-x-2"],["mat-button","",2,"min-width","8rem",3,"click"],["appearance","outline",1,"h-12","flex-1"],["matPrefix","","className","backoffice-magnifying-glass text-xl mr-2"],["matInput","","placeholder","Filter triggers...",1,"rounded-none",3,"ngModel","ngModelChange"],[4,"ngIf","ngIfElse"],["load_state",""],["empty_state",""],["role","table","class","overflow-x-auto",4,"ngIf","ngIfElse"],["role","table",1,"overflow-x-auto"],["table-head",""],[1,"w-12","p-2"],["flex","",1,"flex-1","p-2"],s,[1,"w-16","p-2"],t,_,[1,"w-28","p-2"],i,[1,"w-32","p-2"],["table-body","",1,"overflow-y-auto"],["table-row","",4,"ngFor","ngForOf"],["table-row",""],["hidden","","binding","","mod","_TRIGGER__1",3,"sys","bind","model","modelChange"],[1,"w-12","flex","items-center","justify-center","h-full","p-2"],[1,"h-2","w-2","rounded-full"],[1,"truncate",3,"routerLink"],["desc","",1,"w-16","p-2"],["desc","",1,"w-28","p-2"],[1,"w-32","p-2","items-center","justify-center"],["mat-icon-button","",3,"click"],["className","backoffice-link"],["className","backoffice-edit"],["className","backoffice-trash"],[1,"flex","flex-col","items-center","p-8","mx-auto"],[1,"mb-4",3,"diameter"]]},template:function(t,_){if(1&t&&(e.TgZ(0,"section",0),e.TgZ(1,"button",1),e.NdJ("click",function(){return _.selectTrigger()}),e._uU(2," Add Trigger "),e.qZA(),e.TgZ(3,"mat-form-field",2),e._UZ(4,"app-icon",3),e.TgZ(5,"input",4),e.NdJ("ngModelChange",function(o){return _.filter$.next(o)}),e.qZA(),e.qZA(),e.qZA(),e.TgZ(6,"section"),e.YNc(7,$e,3,4,"ng-container",5),e.ALo(8,"async"),e.qZA(),e.YNc(9,we,4,1,"ng-template",null,6,e.W1O),e.YNc(11,Ye,3,0,"ng-template",null,7,e.W1O)),2&t){const i=e.MAs(10);e.xp6(5),e.Q6J("ngModel",""),e.xp6(2),e.Q6J("ngIf",!e.lcZ(8,3,_.loading).triggers)("ngIfElse",i)}},directives:[v.lW,k.KE,F.o,k.qo,Ue.Nt,S.Fj,S.JJ,S.On,u.O5,u.sg,X.D,b.yS,y.$g],pipes:[u.Ov,Y.R],styles:["[_nghost-%COMP%]{height:100%;width:100%;padding:1rem}[flex][_ngcontent-%COMP%]{min-width:8rem}[role=table][_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{width:100%;min-width:36rem}"]}),n})();function Xe(n,s){1&n&&e._UZ(0,"div",24)}function Ke(n,s){if(1&n){const t=e.EpF();e.TgZ(0,"button",25),e.NdJ("click",function(){e.CHM(t);const i=e.oxw().$implicit;return e.oxw(3).removeZone(i)}),e._UZ(1,"app-icon",26),e.qZA()}}const ke=function(n){return["/zones",n]};function qe(n,s){if(1&n&&(e.TgZ(0,"div",16),e.YNc(1,Xe,1,0,"div",17),e.TgZ(2,"div",18),e._UZ(3,"app-icon",19),e.qZA(),e.TgZ(4,"div",9),e.TgZ(5,"a",20),e._uU(6),e.qZA(),e.qZA(),e.TgZ(7,"div",21),e._uU(8),e.qZA(),e.TgZ(9,"div",22),e.YNc(10,Ke,2,0,"button",23),e.ALo(11,"async"),e.qZA(),e.qZA()),2&n){const t=s.$implicit,_=e.oxw(3);e.xp6(2),e.ekj("pointer-events-none",t.pending)("text-pending",t.pending),e.xp6(1),e.Q6J("className",t.pending?"backoffice-warning":"backoffice-select-arrows"),e.xp6(2),e.Q6J("routerLink",e.VKq(11,ke,t.id)),e.xp6(1),e.hij(" ",t.name," "),e.xp6(2),e.hij(" ",t.description," "),e.xp6(2),e.Q6J("ngIf",e.lcZ(11,9,_.zones).length>1)}}function Ge(n,s){if(1&n){const t=e.EpF();e.TgZ(0,"div",6),e.TgZ(1,"div",7),e._UZ(2,"div",8),e.TgZ(3,"div",9),e.SDv(4,10),e.qZA(),e.TgZ(5,"div",11),e.SDv(6,12),e.qZA(),e._UZ(7,"div",13),e.qZA(),e.TgZ(8,"div",14),e.NdJ("cdkDropListDropped",function(i){return e.CHM(t),e.oxw(2).drop(i)}),e.YNc(9,qe,12,13,"div",15),e.ALo(10,"async"),e.qZA(),e.qZA()}if(2&n){const t=e.oxw(2);e.xp6(9),e.Q6J("ngForOf",e.lcZ(10,1,t.zones))}}function Je(n,s){if(1&n&&(e.ynx(0),e.YNc(1,Ge,11,3,"div",5),e.ALo(2,"async"),e.BQk()),2&n){const t=e.oxw();let _;e.xp6(1),e.Q6J("ngIf",null==(_=e.lcZ(2,1,t.zones))?null:_.length)}}function ze(n,s){1&n&&(e.TgZ(0,"div",27),e._UZ(1,"mat-spinner",28),e.TgZ(2,"p"),e._uU(3,"Loading zones..."),e.qZA(),e.qZA()),2&n&&(e.xp6(1),e.Q6J("diameter",48))}let je=(()=>{class n{constructor(t){this._service=t,this.pending_zones=new M.X([]),this.loading=this._service.loading,this.zones=(0,T.aj)([this._service.zones,this.pending_zones]).pipe((0,f.U)(([_,i])=>[..._,...i.map(o=>Object.assign(Object.assign({},o),{pending:!0}))])),this.query_fn=_=>(0,d.I0G)({q:_}).pipe((0,f.U)(i=>i.data)),this.exclude_fn=_=>this.item.zones.indexOf(_.id)>=0,this.removeZone=_=>_.pending?this.pending_zones.next(this.pending_zones.getValue().filter(i=>i.id!==_.id)):this._service.removeZone(_),this.addPendingZone=_=>this.pending_zones.next([...this.pending_zones.getValue(),_]),this.savePendingZones=()=>(0,m.mG)(this,void 0,void 0,function*(){!this.pending_zones.getValue().length||(yield this._service.addZones(this.pending_zones.getValue()),this.pending_zones.next([]))})}get item(){return this._service.active_item}drop(t){t&&t.previousIndex!==t.currentIndex&&this._service.reorderZones(t.previousIndex,t.currentIndex)}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(h))},n.\u0275cmp=e.Xpm({type:n,selectors:[["system-zones"]],decls:9,vars:8,consts:function(){let s,t;return s=$localize`:@@nameLabel␟cff1428d10d59d14e45edec3c735a27b5482db59␟8953033926734869941:Name`,t=$localize`:@@descriptionLabel␟0f2005f864307f35fc334cb58b20a28b2af7af84␟4993784719124887635: Description `,[[1,"flex","items-center","space-x-2","mb-4"],["name","zone",1,"flex-1","h-12",3,"query_fn","exclude","ngModel","ngModelChange"],["mat-button","",3,"disabled","click"],[4,"ngIf","ngIfElse"],["load_state",""],["role","table","class","overflow-x-auto",4,"ngIf"],["role","table",1,"overflow-x-auto"],["table-head",""],[1,"w-12","p-2"],[1,"w-48","p-2"],s,["desc","",1,"flex-1","p-2"],t,[1,"w-16","p-2"],["body","","cdkDropList","",1,"overflow-y-auto",3,"cdkDropListDropped"],["table-row","","cdkDrag","",4,"ngFor","ngForOf"],["table-row","","cdkDrag",""],["class","w-full h-10 border-2 border-dashed border-gray-600 bg-gray-300 bg-opacity-25",4,"cdkDragPlaceholder"],[1,"w-12","flex","justify-center","h-full","p-2",2,"cursor","grab"],["cdkDragHandle","",3,"className"],[3,"routerLink"],["desc","",1,"flex-1","truncate"],[1,"w-16","p-2","items-center","justify-center"],["mat-icon-button","",3,"click",4,"ngIf"],[1,"w-full","h-10","border-2","border-dashed","border-gray-600","bg-gray-300","bg-opacity-25"],["mat-icon-button","",3,"click"],["className","backoffice-trash"],[1,"flex","flex-col","items-center","p-8","mx-auto"],[1,"mb-4",3,"diameter"]]},template:function(t,_){if(1&t&&(e.TgZ(0,"section",0),e.TgZ(1,"item-search-field",1),e.NdJ("ngModelChange",function(o){return _.addPendingZone(o)}),e.qZA(),e.TgZ(2,"button",2),e.NdJ("click",function(){return _.savePendingZones()}),e._uU(3," Save Pending "),e.qZA(),e.qZA(),e.TgZ(4,"section"),e.YNc(5,Je,3,3,"ng-container",3),e.ALo(6,"async"),e.qZA(),e.YNc(7,ze,4,1,"ng-template",null,4,e.W1O)),2&t){const i=e.MAs(8);e.xp6(1),e.Q6J("query_fn",_.query_fn)("exclude",_.exclude_fn)("ngModel",null),e.xp6(1),e.Q6J("disabled",!_.pending_zones.getValue().length),e.xp6(3),e.Q6J("ngIf",!e.lcZ(6,6,_.loading).zones)("ngIfElse",i)}},directives:[D.y,S.JJ,S.On,v.lW,u.O5,E.Wj,u.sg,E.Zt,E.Hk,F.o,E.Bh,b.yS,y.$g],pipes:[u.Ov],styles:["[_nghost-%COMP%]{height:100%;width:100%;padding:1rem}[desc][_ngcontent-%COMP%]{min-width:8rem}"]}),n})();var Qe=l(3427),He=l(4307),q=l(395),Ve=l(6195),Z=l(3050),We=l(3013);function et(n,s){if(1&n){const t=e.EpF();e.TgZ(0,"button",19),e.NdJ("click",function(i){return i.stopPropagation()})("click",function(){e.CHM(t);const i=e.oxw(3).$implicit;return e.oxw(3).saveMetadata(i)}),e.SDv(1,20),e.qZA()}}function tt(n,s){if(1&n&&(e.ynx(0),e.YNc(1,et,2,0,"button",18),e.BQk()),2&n){const t=e.oxw(2).$implicit,_=e.oxw(3),i=e.MAs(4);e.xp6(1),e.Q6J("ngIf",!_.loading[t.name])("ngIfElse",i)}}const _t=function(){return{class:"backoffice-trash"}};function nt(n,s){if(1&n){const t=e.EpF();e.TgZ(0,"div",21),e.TgZ(1,"button",22),e.NdJ("click",function(){e.CHM(t);const i=e.oxw(2).$implicit;return e.oxw(3).deleteMetadata(i.name)}),e._UZ(2,"app-icon",14),e.qZA(),e.qZA()}2&n&&(e.xp6(2),e.Q6J("icon",e.DdM(1,_t)))}const it=function(){return{class:"backoffice-edit"}};function ot(n,s){if(1&n){const t=e.EpF();e.TgZ(0,"mat-expansion-panel",10),e.TgZ(1,"mat-expansion-panel-header"),e.TgZ(2,"mat-panel-title"),e.TgZ(3,"div",11),e._uU(4),e.qZA(),e.YNc(5,tt,2,2,"ng-container",12),e.TgZ(6,"button",13),e.NdJ("click",function(i){e.CHM(t);const o=e.oxw().$implicit;return e.oxw(3).editMetadataDetails(o),i.stopPropagation()}),e._UZ(7,"app-icon",14),e.qZA(),e.YNc(8,nt,3,2,"div",15),e.qZA(),e.qZA(),e.TgZ(9,"div",16),e._UZ(10,"settings-form-field",17),e.qZA(),e.qZA()}if(2&n){const t=e.oxw().$implicit,_=e.oxw(3);e.ekj("no-padding",!0),e.Q6J("formGroup",_.form_map[t.name]),e.xp6(4),e.hij(" ",_.form_map[t.name].controls.name.value," "),e.xp6(1),e.Q6J("ngIf",_.edited[t.name]),e.xp6(2),e.Q6J("icon",e.DdM(9,it)),e.xp6(1),e.Q6J("ngIf",!t.new),e.xp6(2),e.Q6J("schema",_.schema_map[t.name])("readonly",!1)}}function st(n,s){if(1&n&&(e.ynx(0),e.YNc(1,ot,11,10,"mat-expansion-panel",9),e.BQk()),2&n){const t=s.$implicit,_=e.oxw(3);e.xp6(1),e.Q6J("ngIf",_.form_map[t.name])}}function at(n,s){if(1&n&&(e.TgZ(0,"div",7),e.TgZ(1,"mat-accordion"),e.YNc(2,st,2,1,"ng-container",8),e.qZA(),e.qZA()),2&n){const t=e.oxw(2);e.xp6(2),e.Q6J("ngForOf",t.metadata)}}function ct(n,s){if(1&n){const t=e.EpF();e.TgZ(0,"div",3),e.TgZ(1,"button",4),e.NdJ("click",function(){return e.CHM(t),e.oxw().newMetadata()}),e.SDv(2,5),e.qZA(),e.YNc(3,at,3,1,"div",6),e.qZA()}if(2&n){const t=e.oxw(),_=e.MAs(2);e.xp6(3),e.Q6J("ngIf",t.metadata&&t.metadata.length>0)("ngIfElse",_)}}function lt(n,s){1&n&&(e.TgZ(0,"div",23),e.TgZ(1,"div",24),e.SDv(2,25),e.qZA(),e.qZA())}function dt(n,s){1&n&&e._UZ(0,"mat-spinner",26)}let rt=(()=>{class n extends P.K{constructor(t,_,i){super(),this._dialog=t,this._service=_,this._schemas=i,this.metadata=[],this.form_map={},this.edited={},this.loading={},this.schema_map={}}get item(){return this._service.active_item}validateName(t){return _=>t.indexOf(_.value)>=0?{name:!0}:null}ngOnInit(){this.subscription("item",this._service.item.subscribe(t=>{this.loadMetadata()}))}newMetadata(){this.metadata.push({name:`new_field_${Math.floor(999999999*Math.random())}`,description:"",new:!0,details:{}}),this.generateForms()}editMetadataDetails(t){this._dialog.open(He.v,{maxWidth:"95vw",data:{form:this.form_map[t.name]}})}deleteMetadata(t){const _=this._dialog.open(q.z,Object.assign(Object.assign({},q.t),{data:{title:"Kill process",content:`\n                    <p>Are you sure you want delete the metadata property "${t}"?</p>\n                `,icon:{type:"icon",class:"backoffice-trash"}}}));this.subscription("confirm",_.componentInstance.event.subscribe(i=>{"done"===i.reason&&(0,d._p1)(this.item.id,{name:t}).subscribe(()=>{(0,r.t5)(`Successfully removed "${t}" metadata.`),this.metadata=this.metadata.filter(o=>o.name!==t),this.generateForms()},o=>(0,r.cB)(`Error removing old "${t}" metadata. Error: ${o.response||o.message||o}`)),_.close()}))}saveMetadata(t){const _=this.form_map[t.name];if(_.markAllAsTouched(),!_.valid)return(0,r.cB)(`JSON for property "${_.controls.name.value}" is invalid`);const i=_.value;this.loading[t.name]=!0,(0,d.Ymr)(this.item.id,Object.assign(Object.assign({},i),{details:JSON.parse(i.details)})).subscribe(o=>{this.loading[t.name]=!1;const a=this.metadata.findIndex(c=>c.name===t.name);this.edited[t.name]=!1,t.name!==o.name&&(0,d._p1)(this.item.id,t).toPromise().catch(c=>(0,r.cB)(`Error removing old "${t.name}" metadata. Error: ${JSON.stringify(c.response||c.message||c)}`)),a>=0&&this.metadata.splice(a,1,Object.assign(Object.assign({},o),{new:!1})),(0,r.t5)(`Saved "${i.name}" metadata.`),this.generateForms()},o=>{this.loading[t.name]=!1,(0,r.cB)(`Error saving "${i.name}" metadata. Error: ${JSON.stringify(o.response||o.message||o)}`)})}generateForms(){delete this.form_map,this.form_map={},this.metadata.forEach(t=>{const _="string"==typeof t.details?JSON.parse(t.details):t.details;this.form_map[t.name]=new S.cw({name:new S.NI(t.name,[S.kI.required,this.validateName(this.metadata.filter(i=>i.name!==t.name).map(i=>i.name))]),description:new S.NI(t.description),editors:new S.NI(t.editors),details:new S.NI(JSON.stringify(_||{},void 0,4),[S.kI.required,Qe.NS]),schema:new S.NI(t.schema)}),this.subscription(`${t.name}_changes`,this.form_map[t.name].valueChanges.subscribe(()=>this.edited[t.name]=!0)),this.subscription(`${t.name}_schema`,this.form_map[t.name].controls.schema.valueChanges.subscribe(i=>{let o=this._schemas.getSchema(i);if(!o)try{o=JSON.parse(i)}catch(a){o={}}this.schema_map[t.name]=o}))})}loadMetadata(){(0,d.Eio)(this.item.id).subscribe(t=>{this.metadata=Object.keys(t).map(_=>t[_]),this.generateForms()})}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(U.uw),e.Y36(w.L),e.Y36(Ve.O))},n.\u0275cmp=e.Xpm({type:n,selectors:[["system-metadata"]],features:[e.qOj],decls:5,vars:1,consts:function(){let s,t,_;return s=$localize`:@@addMetadataAction␟21539c364f82b6b766d912c3734a014cb30f27a9␟6503325999299484981: Add new Metadata Field `,t=$localize`:@@saveAction␟baa3a276f05a6226cb663918714882c53b84da34␟25086637338905953: Save `,_=$localize`:@@zoneMetadataEmpty␟9efcb2e7d3516841bad5ea1dadad17ecbf398ef1␟8996986316640896080: No zone metadata found `,[["class","p-4",4,"ngIf"],["empty_state",""],["load_state",""],[1,"p-4"],["mat-button","",3,"click"],s,["class","mt-4",4,"ngIf","ngIfElse"],[1,"mt-4"],[4,"ngFor","ngForOf"],[3,"no-padding","formGroup",4,"ngIf"],[3,"formGroup"],["edit","",1,"flex-1"],[4,"ngIf"],["mat-icon-button","","matTooltip","Edit Metadata Settings",3,"click"],[3,"icon"],["class","contents",4,"ngIf"],[1,"settings"],["formControlName","details","lang","json",3,"schema","readonly"],["mat-button","","save","",3,"click",4,"ngIf","ngIfElse"],["mat-button","","save","",3,"click"],t,[1,"contents"],["mat-icon-button","","matTooltip","Remove Metadata",3,"click"],[1,"info-block"],[1,"text"],_,["diameter","32"]]},template:function(t,_){1&t&&(e.YNc(0,ct,4,2,"div",0),e.YNc(1,lt,3,0,"ng-template",null,1,e.W1O),e.YNc(3,dt,1,0,"ng-template",null,2,e.W1O)),2&t&&e.Q6J("ngIf",_.item)},directives:[u.O5,v.lW,Z.pp,u.sg,Z.ib,S.JL,S.sg,Z.yz,Z.yK,K.gM,F.o,We.x,S.JJ,S.u,y.$g],styles:["[edit][_ngcontent-%COMP%]   app-icon[_ngcontent-%COMP%]{opacity:0;transition:opacity .2s}[edit][_ngcontent-%COMP%]:hover   app-icon[_ngcontent-%COMP%]{opacity:1}mat-panel-title[_ngcontent-%COMP%]{display:flex;align-items:center;height:1.2em;overflow:visible}mat-panel-title[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{font-size:.8em;background:none;border:none;text-decoration:underline;color:inherit}mat-form-field[_ngcontent-%COMP%]{height:3em}.settings[_ngcontent-%COMP%]{width:100%}.contents[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;flex:1;min-width:2em}.contents[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{text-decoration:none}"]}),n})();var mt=l(5605),St=l(8051);const gt=[{path:":id",component:ee,children:[{path:"",redirectTo:"about"},{path:"about",component:ge},{path:"modules",component:Re},{path:"triggers",component:De},{path:"zones",component:je},{path:"metadata",component:rt},{path:"extend/:id",component:mt.z},{path:"history",component:St.D},{path:"**",redirectTo:"about"}]},{path:"**",redirectTo:"-"}];var ut=l(1226);let pt=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[u.ez,S.u5,S.UX,b.Bz.forChild(gt),ut.X,E._t]]}),n})()}}]);