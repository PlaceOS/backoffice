(self.webpackChunkplaceos=self.webpackChunkplaceos||[]).push([[389],{8389:(e,t,i)=>{"use strict";i.r(t),i.d(t,{AppSystemsModule:()=>nt});var n=i(1511),s=i(3695),o=i(6898),a=i(8975),c=i(8194),r=i(5697),d=i(1572),l=i(4762),m=i(5802),g=i(8512),u=i(3080),f=i(7701),p=i(4689),h=i(9996),v=i(8303),b=i(3530),_=i(4103),Z=i(8739),x=i(4415),y=i(3206),w=i(5646),A=i(5712),T=i(5385),q=i(4608);let k=(()=>{class e extends c.K{constructor(e,t,i){super(),this._state=e,this._debug=t,this._dialog=i,this.item=this._state.item,this._loading=new g.X({}),this._modules=new g.X([]),this._change=new g.X(0),this.associated_settings=this._state.all_item.pipe((0,f.b)(300),(0,p.w)(e=>e&&e instanceof m.G6j?(0,m.aPQ)(e.id):[])),this.counts=(0,u.aj)([this._state.all_item,this._change]).pipe((0,f.b)(300),(0,p.w)(e=>(0,l.mG)(this,void 0,void 0,function*(){const[t]=e;if(!(t&&t instanceof m.G6j))return{};this._loading.next(Object.assign(Object.assign({},this._loading.getValue()),{settings:!0}));const i=yield Promise.all([(0,m.vNE)(t.id).pipe((0,h.U)(e=>e.total)).toPromise(),(0,m.Eio)(t.id).toPromise()]),[n,s]=i;return this._loading.next(Object.assign(Object.assign({},this._loading.getValue()),{settings:!1})),{devices:t.modules.length,zones:t.zones.length,triggers:n,metadata:s.length}}))),this.modules=(0,u.aj)([this.item,this._change]).pipe((0,p.w)(e=>(0,l.mG)(this,void 0,void 0,function*(){const t=e[0];if(!(t&&t instanceof m.G6j))return[];this._loading.next(Object.assign(Object.assign({},this._loading.getValue()),{modules:!0}));const i=yield(0,m.Ne_)({control_system_id:t.id,complete:!0,limit:200}).pipe((0,h.U)(e=>e.data)).toPromise();return this._loading.next(Object.assign(Object.assign({},this._loading.getValue()),{modules:!1})),i.sort((e,i)=>t.modules.indexOf(e.id)-t.modules.indexOf(i.id)),this._modules.next(i),i})),(0,v.d)()),this.debug_state=this.modules.pipe((0,h.U)(e=>e.reduce((e,t)=>(e[t.id]=this._debug.isListening(t),e),{}))),this.module_bindings=this.modules.pipe((0,h.U)(e=>e.map(t=>`${t.custom_name||t.name||"Blank"}_${(0,r.U0)(e,t)}`)),(0,v.d)()),this.zones=this._state.item.pipe((0,p.w)(e=>(0,l.mG)(this,void 0,void 0,function*(){if(!(e&&e instanceof m.G6j))return[];this._loading.next(Object.assign(Object.assign({},this._loading.getValue()),{zones:!0}));const t=yield(0,m.Lx_)(e.id).pipe((0,h.U)(e=>e.data)).toPromise();return t.sort((t,i)=>e.zones.indexOf(t.id)-e.zones.indexOf(i.id)),this._loading.next(Object.assign(Object.assign({},this._loading.getValue()),{zones:!1})),t})),(0,v.d)()),this.triggers=(0,u.aj)([this.item,this._change]).pipe((0,p.w)(e=>(0,l.mG)(this,void 0,void 0,function*(){const[t]=e;if(!(t&&t instanceof m.G6j))return[];this._loading.next(Object.assign(Object.assign({},this._loading.getValue()),{triggers:!0}));const i=yield(0,m.vNE)(t.id).pipe((0,h.U)(e=>e.data)).toPromise();return this._loading.next(Object.assign(Object.assign({},this._loading.getValue()),{triggers:!1})),i})),(0,v.d)()),this.loading=this._loading.asObservable(),this.getModules=()=>this._modules.getValue()}get active_item(){return this._state.active_item||{}}startSystem(){return(0,l.mG)(this,void 0,void 0,function*(){const e=yield this.confirm({title:"Start system?",content:"Are you sure you want to start this system?<br>All stopped modules within the system will boot up.",icon:{type:"icon",class:"backoffice-controller-play"}});e&&e.reason&&(e.loading("Starting system..."),(yield(0,m.igg)(this.active_item.id).toPromise().catch(e=>((0,Z.cB)(`Failed to start system: ${JSON.stringify(e.response||e.message||e)}`),e)))||(0,Z.t5)("Successfully started system"),e.close())})}stopSystem(){return(0,l.mG)(this,void 0,void 0,function*(){const e=yield this.confirm({title:"Stop system?",content:"Are you sure you want to stop this system?<br>All modules will be immediately stopped regardless of any other systems they may be in.",icon:{type:"icon",class:"backoffice-controller-stop"}});e&&e.reason&&(e.loading("Stopping system..."),(yield(0,m.edN)(this.active_item.id).toPromise().catch(e=>((0,Z.cB)(`Failed to stop system: ${JSON.stringify(e.response||e.message||e)}`),e)))||(0,Z.t5)("Successfully stopped system"),e.close())})}toggleModuleDebug(e){e&&(this._debug.isListening(e)?this._debug.unbind(e):this._debug.bind(e,`${e.custom_name||e.name||"Blank"}_${(0,r.U0)(this._modules.getValue(),e)}`))}newModule(){return(0,l.mG)(this,void 0,void 0,function*(){const e=yield this._state.edit(new m.SQz({system:this.active_item,control_system_id:this.active_item.id})).catch(e=>null);e&&this.joinModule(e.id)})}editModule(e){return(0,l.mG)(this,void 0,void 0,function*(){yield this._state.edit(e).catch(e=>null),this._change.next(Date.now())})}selectTrigger(){return(0,l.mG)(this,void 0,void 0,function*(){const e=this._dialog.open(y.f,{data:{service_name:"Triggers",query_fn:e=>(0,m.$Um)({q:e}).pipe((0,h.U)(e=>e.data))}}),t=yield Promise.race([e.componentInstance.event.pipe((0,b.P)(e=>"action"===e.reason)).toPromise(),e.afterClosed().toPromise()]);if(!t||!t.reason)return e.close();const i=yield this.addTrigger(e.componentInstance.item);return e.close(),this._change.next(Date.now()),i})}addTrigger(e){return(0,l.mG)(this,void 0,void 0,function*(){const t=yield(0,m.nq4)(this.active_item.id,{control_system_id:this.active_item.id,enabled:!0,important:!1,trigger_id:e.id}).toPromise();return this.timeout("change",()=>this._change.next(Date.now())),t})}editTrigger(e){return(0,l.mG)(this,void 0,void 0,function*(){if(this.item&&e){const t=this._dialog.open(x.K,{height:"auto",width:"auto",maxHeight:"calc(100vh - 2em)",maxWidth:"calc(100vw - 2em)",data:{item:e,name:"Trigger",save:e=>(0,m.dqJ)(e.id,e),external_save:!0}}),i=yield Promise.race([t.componentInstance.event.pipe((0,b.P)(e=>"action"===e.reason)).toPromise(),t.afterClosed().toPromise()]);if(!i||!i.reason)return;t.componentInstance.loading="Saving trigger settings...";const n=`${(0,m._ds)()}/systems/${this.active_item.id}/triggers/${e.id}`,s=yield(0,m.gzd)(n,i.metadata).toPromise().catch(e=>{throw(0,Z.cB)(`Error updating trigger settings. Error: ${JSON.stringify(e.response||e.message||e)}`),e});return t.close(),s?((0,Z.t5)("Successfully updated trigger settings."),this.timeout("change",()=>this._change.next(Date.now())),s):e}})}removeTrigger(e){return(0,l.mG)(this,void 0,void 0,function*(){const t=yield this.confirm({title:"Remove trigger",content:`<p>Are you sure you want remove trigger "${e.name}"?</p><p>Configuration will be updated <strong>immediately</strong>.</p>`,icon:{type:"icon",class:"backoffice-trash"}});t&&t.reason&&(yield(0,m.LfU)(this.active_item.id,e.id).toPromise().catch(i=>{throw t.close(),(0,Z.cB)(`Error removing trigger ${e.id} from system. Error: ${i.statusText||i.message||i}`),i}),t.close(),(0,Z.t5)("Successfully removed trigger from system."),this._change.next(Date.now()))})}reorderModules(e,t){return(0,l.mG)(this,void 0,void 0,function*(){const i=yield this.confirm({title:"Change order?",content:"Are you sure you want to change the module priority?<br>Settings will be updated immediately for the system.",icon:{type:"icon",class:"backoffice-layers"}});if(!i||!i.reason)return;i.loading("Updating module order...");const n=[...this.active_item.modules];(0,a.bA)(n,e,t);const s=yield(0,m.EQg)(this.active_item.id,Object.assign(Object.assign({},this.active_item),{modules:n})).toPromise().catch(e=>((0,Z.cB)(`Failed to reorder system modules: ${JSON.stringify(e.response||e.message||e)}`),e));i.close(),s instanceof m.G6j&&((0,Z.t5)("Successfully reordered system modules."),this._state.replaceItem(s))})}reorderZones(e,t){return(0,l.mG)(this,void 0,void 0,function*(){const i=yield this.confirm({title:"Change order?",content:"Are you sure you want to change the zone priority?<br>Settings will be updated immediately for the system.",icon:{type:"icon",class:"backoffice-layers"}});if(!i||!i.reason)return;i.loading("Updating zone order...");const n=[...this.active_item.zones];(0,a.bA)(n,e,t);const s=yield(0,m.EQg)(this.active_item.id,Object.assign(Object.assign({},this.active_item),{zones:n})).toPromise().catch(e=>((0,Z.cB)(`Failed to reorder system zones: ${JSON.stringify(e.response||e.message||e)}`),e));s instanceof m.G6j&&((0,Z.t5)("Successfully reordered system zones."),this._state.replaceItem(s)),i.close()})}joinModule(e){return(0,l.mG)(this,void 0,void 0,function*(){const t=yield(0,m.y_E)(this.active_item.id,e).toPromise().catch(t=>{(0,Z.cB)(`Error adding module ${e} to system. Error: ${t.statusText||t.message||t}`)});t&&(this._state.replaceItem(t),(0,Z.t5)("Successfully added module to system."),this._change.next(Date.now()))})}removeModule(e){return(0,l.mG)(this,void 0,void 0,function*(){const t=yield this.confirm({title:"Remove module?",content:`Remove ${e.driver_id} from this system?<br>If this is not used elsewhere the associated data will be removed immediately.`,icon:{type:"icon",class:"backoffice-trash"}});if(!t||!t.reason)return;const i=yield(0,m.zed)(this.active_item.id,e.id).toPromise().catch(t=>{(0,Z.cB)(`Error removing module ${e.id} from system. Error: ${t.statusText||t.message||t}`)});t.close(),i&&(this._state.replaceItem(i),(0,Z.t5)("Successfully removed module from system."))})}reloadModule(e){var t;return(0,l.mG)(this,void 0,void 0,function*(){const i=yield this.confirm({title:"Recompile module?",content:"New driver code will be loaded and the device settings will be reloaded.",icon:{type:"icon",class:"backoffice-install"}});i&&i.reason&&(i.loading("Recompiling and reloading driver..."),yield(0,m.qEr)((null===(t=e.driver)||void 0===t?void 0:t.id)||e.driver_id).toPromise().catch(t=>{throw(0,Z.cB)(`Error removing module ${e.id} from system. Error: ${t.statusText||t.message||t}`),t}),(0,Z.t5)("Successfully removed module from system."),i.close())})}addZones(e){return(0,l.mG)(this,void 0,void 0,function*(){const t=(0,_.Tw)([...this.active_item.zones,...e.map(e=>e.id)]),i=yield(0,m.EQg)(this.active_item.id,Object.assign(Object.assign({},this.active_item),{zones:t})).toPromise().catch(t=>{(0,Z.cB)(`Error adding ${e.length} zone(s) to system. Error: ${t.statusText||t.message||t}`)});i&&(this._state.replaceItem(i),(0,Z.t5)("Successfully added zone to system."))})}removeZone(e){return(0,l.mG)(this,void 0,void 0,function*(){const t=yield this.confirm({title:"Remove zone?",content:`<p>Are you sure you want remove zone "${e.name}" from the system?</p>Configuration will be updated immediately.`,icon:{type:"icon",class:"backoffice-trash"}});if(!t||!t.reason)return;const i=this.active_item.zones.filter(t=>t!==e.id),n=yield(0,m.EQg)(this.active_item.id,Object.assign(Object.assign({},this.active_item),{zones:i})).toPromise().catch(t=>{(0,Z.cB)(`Error removing zone ${e.id} from system. Error: ${t.statusText||t.message||t}`)});t.close(),n&&(this._state.replaceItem(n),(0,Z.t5)("Successfully removed zone from system."))})}toggleModulePower(e){return(0,l.mG)(this,void 0,void 0,function*(){const t=e.running?m.iAP:m.Dqv;yield t(e.id).toPromise().catch(t=>{throw"string"==typeof t&&t.length<64?(0,Z.cB)(t):(0,Z.cB)(`Failed to ${e.running?"stop":"start"} module '${e.id}'.\nView Error?`,"View",()=>this.viewDetails(t)),t}),(0,Z.t5)("Module successfully "+(e.running?"stopped":"started")),e.running=!e.running})}viewDetails(e){this._dialog.open(w.a,{data:{content:e}})}confirm(e){return(0,l.mG)(this,void 0,void 0,function*(){return(0,_._5)(e,this._dialog)})}}return e.\u0275fac=function(t){return new(t||e)(d.LFG(A.L),d.LFG(T.i),d.LFG(q.uw))},e.\u0275prov=d.Yz7({token:e,factory:e.\u0275fac,providedIn:"root"}),e})();var M=i(7096),O=i(6478);let N=(()=>{class e extends c.K{constructor(e){super(),this._service=e,this.name="systems",this.tab_list=[]}get extensions(){return(0,r.fq)(this._service.active_item,this.name)}updateTabList(e){this.tab_list=[{id:"about",name:"About",icon:{class:"backoffice-info-with-circle"}},{id:"modules",name:"Modules",count:e.devices,icon:{class:"backoffice-tablet"}},{id:"zones",name:"Zones",count:e.zones,icon:{class:"backoffice-layers"}},{id:"triggers",name:"Triggers",count:e.triggers,icon:{class:"backoffice-stopwatch"}},{id:"metadata",name:"Metadata",count:e.metadata,icon:{class:"backoffice-gist"}},{id:"history",name:"Settings History",icon:{class:"backoffice-clock"}}].concat(this.extensions)}ngOnInit(){this.updateTabList({}),this.subscription("counts",this._service.counts.subscribe(e=>this.updateTabList(e)))}}return e.\u0275fac=function(t){return new(t||e)(d.Y36(k))},e.\u0275cmp=d.Xpm({type:e,selectors:[["app-systems"]],features:[d.qOj],decls:3,vars:1,consts:[[1,"flex-1","flex-col","sm:flex-row","flex","h-full","w-full","relative"],["heading","Systems","name","systems",1,"absolute","top-0","left-0","h-12","w-full","sm:h-full","sm:static"],["name","system","route","systems",1,"flex-1","relative","mt-12","sm:mt-0","w-full","sm:w-1/2",3,"tabs"]],template:function(e,t){1&e&&(d.TgZ(0,"div",0),d._UZ(1,"sidebar",1),d._UZ(2,"item-display",2),d.qZA()),2&e&&(d.xp6(2),d.Q6J("tabs",t.tab_list))},directives:[M.k,O.s],styles:["sidebar[_ngcontent-%COMP%]{transition:height .3s}@media screen and (min-width:640px){sidebar[_ngcontent-%COMP%]{width:20em!important}}"]}),e})();var J=i(5980),$=i(9441),I=i(7806),S=i(6529);function C(e,t){if(1&e&&(d.TgZ(0,"div",11),d.TgZ(1,"label"),d.SDv(2,12),d.qZA(),d.TgZ(3,"div",13),d.TgZ(4,"a",14),d._uU(5),d.qZA(),d.qZA(),d.qZA()),2&e){const e=d.oxw();d.xp6(4),d.Q6J("href",null==e.item?null:e.item.support_url,d.LSH),d.xp6(1),d.Oqu(null==e.item?null:e.item.support_url)}}function z(e,t){if(1&e&&(d.TgZ(0,"div",11),d.TgZ(1,"label"),d.SDv(2,15),d.qZA(),d.TgZ(3,"div",13),d._uU(4),d.qZA(),d.qZA()),2&e){const e=d.oxw();d.xp6(4),d.Oqu(null!=e.item&&e.item.bookable?"Yes":"No")}}function U(e,t){if(1&e&&(d.TgZ(0,"a",18),d._uU(1),d.qZA()),2&e){const e=d.oxw(2);d.Q6J("href","mailto:"+(null==e.item?null:e.item.email),d.LSH),d.xp6(1),d.Oqu(null==e.item?null:e.item.email)}}function P(e,t){if(1&e&&(d.TgZ(0,"div",11),d.TgZ(1,"label"),d.SDv(2,16),d.qZA(),d.YNc(3,U,2,2,"a",17),d.qZA()),2&e){const e=d.oxw();d.xp6(3),d.Q6J("ngIf",null==e.item?null:e.item.email)}}function j(e,t){if(1&e&&(d.TgZ(0,"div",11),d.TgZ(1,"label"),d.SDv(2,19),d.qZA(),d.TgZ(3,"div",13),d._uU(4),d.qZA(),d.qZA()),2&e){const e=d.oxw();d.xp6(4),d.Oqu(null==e.item?null:e.item.capacity)}}function L(e,t){if(1&e&&(d.TgZ(0,"div",11),d.TgZ(1,"label"),d.SDv(2,20),d.qZA(),d.TgZ(3,"div",13),d._uU(4),d.qZA(),d.qZA()),2&e){const e=d.oxw();d.xp6(4),d.Oqu(null==e.item?null:e.item.map_id)}}function Q(e,t){if(1&e&&(d.TgZ(0,"div",11),d.TgZ(1,"label"),d.SDv(2,21),d.qZA(),d.TgZ(3,"div",13),d._uU(4),d.qZA(),d.qZA()),2&e){const e=d.oxw();d.xp6(4),d.Oqu(null==e.item?null:e.item.installed_ui_devices)}}function E(e,t){if(1&e&&(d.TgZ(0,"div",11),d.TgZ(1,"label"),d.SDv(2,22),d.qZA(),d.TgZ(3,"div",13),d._uU(4),d.ALo(5,"dateFrom"),d.qZA(),d.qZA()),2&e){const e=d.oxw();d.xp6(4),d.Oqu(d.lcZ(5,1,1e3*(null==e.item?null:e.item.created_at)))}}function D(e,t){if(1&e&&(d.TgZ(0,"div",11),d.TgZ(1,"label"),d.SDv(2,23),d.qZA(),d.TgZ(3,"div",13),d._uU(4),d.ALo(5,"dateFrom"),d.qZA(),d.qZA()),2&e){const e=d.oxw();d.xp6(4),d.Oqu(d.lcZ(5,1,1e3*(null==e.item?null:e.item.updated_at)))}}const Y=function(){return[]};function F(e,t){if(1&e&&(d.TgZ(0,"section"),d._UZ(1,"a-settings-form",24),d.ALo(2,"async"),d.qZA()),2&e){const e=d.oxw();d.xp6(1),d.Q6J("id",null==e.item?null:e.item.id)("merge",!0)("settings",null==e.item?null:e.item.settings)("merge_settings",d.lcZ(2,4,e.other_settings)||d.DdM(6,Y))}}function G(e,t){1&e&&(d.TgZ(0,"div",25),d._UZ(1,"mat-spinner",26),d.TgZ(2,"p"),d.SDv(3,27),d.qZA(),d.qZA()),2&e&&(d.xp6(1),d.Q6J("diameter",32))}let B=(()=>{class e{constructor(e){this._service=e,this.other_settings=this._service.associated_settings,this.start=()=>this._service.startSystem(),this.stop=()=>this._service.stopSystem()}get item(){return this._service.active_item}}return e.\u0275fac=function(t){return new(t||e)(d.Y36(k))},e.\u0275cmp=d.Xpm({type:e,selectors:[["system-about"]],decls:20,vars:10,consts:function(){let e,t,i,n,s,o,a,c,r,d,l,m;return e=$localize`:@@systemStartAction␟a0ad4d2f6db5011522b27a74a8a3f25fbcd91d05␟5385791890561823613: Start System `,t=$localize`:@@systemStopAction␟68db1b4a8dd3dfae41bbe41a32a4cbf32d44e077␟3926711479790873070: Stop System `,i=$localize`:@@settingsLabel␟121cc5391cd2a5115bc2b3160379ee5b36cd7716␟4930506384627295710:Settings`,n=$localize`:@@systemUrlLabel␟7e26fea74dd85099364f23205324001d5f08d729␟206794270698958656:Support URL:`,s=$localize`:@@systemBookableLabel␟1729892dec33ddc3daf35f197b6882eb1c4a8a1b␟238801422848943760:Bookable Room:`,o=$localize`:@@emailLabel␟31703f614ddd8547d63317830a59c0a7b935778e␟8507709425849513695:Email: `,a=$localize`:@@capacityLabel␟a1170e85d1897210d5fe03d1f363587de15d02cd␟8062822823331512246:Capacity:`,c=$localize`:@@mapIdLabel␟46a8087017d0d929ed6d398ba5d3a5ea1be7ab9b␟1613414518051599973:Map ID:`,r=$localize`:@@systemPanelCountLabel␟45b07d34ed29d3a5269b5bac86182781001845a9␟4375591254429334656:Installed Touch Panels:`,d=$localize`:@@systemCreatedAtLabel␟a5ed099ffc9e96f6970df843289ade8a7d20ab9f␟1616250945945379783:Created:`,l=$localize`:@systemUpdatedAtLabel␟f94240161f912dbd8758b858877cddeab80f36cb␟1116759395536210856:Updated:`,m=$localize`:@@systemLoadingLabel␟12761354f7c79edc553ff408524f5b791cd54481␟3385246531183416995:Loading system settings...`,[[1,"flex","items-center","space-x-2","mb-4"],["mat-button","",1,"flex-1","sm:flex-none",3,"click"],e,t,[1,"details"],["class","flex items-center space-x-2",4,"ngIf"],[1,"my-4"],[1,"font-medium","text-lg"],i,[4,"ngIf","ngIfElse"],["load_state",""],[1,"flex","items-center","space-x-2"],n,[1,"value"],["target","_blank",1,"underline",3,"href"],s,o,["class","underline select-all","target","_blank",3,"href",4,"ngIf"],["target","_blank",1,"underline","select-all",3,"href"],a,c,r,d,l,[3,"id","merge","settings","merge_settings"],[1,"flex","flex-col","p-8","items-center","justify-center"],[1,"mb-4",3,"diameter"],m]},template:function(e,t){if(1&e&&(d.TgZ(0,"section",0),d.TgZ(1,"button",1),d.NdJ("click",function(){return t.start()}),d.SDv(2,2),d.qZA(),d.TgZ(3,"button",1),d.NdJ("click",function(){return t.stop()}),d.SDv(4,3),d.qZA(),d.qZA(),d.TgZ(5,"section",4),d.YNc(6,C,6,2,"div",5),d.YNc(7,z,5,1,"div",5),d.YNc(8,P,4,1,"div",5),d.YNc(9,j,5,1,"div",5),d.YNc(10,L,5,1,"div",5),d.YNc(11,Q,5,1,"div",5),d.YNc(12,E,6,3,"div",5),d.YNc(13,D,6,3,"div",5),d.qZA(),d._UZ(14,"hr",6),d.TgZ(15,"header",7),d.SDv(16,8),d.qZA(),d.YNc(17,F,3,7,"section",9),d.YNc(18,G,4,1,"ng-template",null,10,d.W1O)),2&e){const e=d.MAs(19);d.xp6(6),d.Q6J("ngIf",null==t.item?null:t.item.support_url),d.xp6(1),d.Q6J("ngIf",null==t.item?null:t.item.bookable),d.xp6(1),d.Q6J("ngIf",null==t.item?null:t.item.email),d.xp6(1),d.Q6J("ngIf",null==t.item?null:t.item.capacity),d.xp6(1),d.Q6J("ngIf",null==t.item?null:t.item.map_id),d.xp6(1),d.Q6J("ngIf",null==t.item?null:t.item.installed_ui_devices),d.xp6(1),d.Q6J("ngIf",null==t.item?null:t.item.created_at),d.xp6(1),d.Q6J("ngIf",null==t.item?null:t.item.updated_at),d.xp6(4),d.Q6J("ngIf",(null==t.item?null:t.item.settings)&&t.other_settings)("ngIfElse",e)}},directives:[J.lW,n.O5,$.v,I.$g],pipes:[S.R,n.Ov],styles:["[_nghost-%COMP%]{padding:1rem;height:100%;width:100%}button[_ngcontent-%COMP%]{min-width:8rem}"]}),e})();var H=i(9941),V=i(6678),W=i(1179),R=i(8073),X=i(3609),K=i(5204),ee=i(9236),te=i(8055);function ie(e,t){if(1&e&&(d.TgZ(0,"section",14),d.TgZ(1,"h3",11),d.SDv(2,15),d.qZA(),d._UZ(3,"execute-method-field",16),d.qZA()),2&e){const e=d.oxw(2);d.xp6(3),d.Q6J("system",e.item)}}function ne(e,t){1&e&&d._UZ(0,"div",50)}function se(e,t){if(1&e&&(d.TgZ(0,"div",51),d._uU(1),d.qZA()),2&e){const e=d.oxw().$implicit;d.xp6(1),d.hij(" ",e.notes," ")}}function oe(e,t){1&e&&d._UZ(0,"app-icon",52)}function ae(e,t){if(1&e){const e=d.EpF();d.TgZ(0,"button",53),d.NdJ("click",function(){const t=d.CHM(e).$implicit,i=d.oxw().$implicit;return d.oxw(4).handleContextEvent(t,i)}),d._UZ(1,"app-icon",46),d.TgZ(2,"div",54),d._uU(3),d.qZA(),d.qZA()}if(2&e){const e=t.$implicit;d.xp6(1),d.Q6J("icon",e.icon),d.xp6(2),d.hij(" ",e.name," ")}}const ce=function(e){return["/modules",e]},re=function(){return{class:"backoffice-edit"}},de=function(){return{class:"backoffice-dots-three-vertical"}};function le(e,t){if(1&e){const e=d.EpF();d.TgZ(0,"div",30),d.NdJ("contextAction",function(t){const i=d.CHM(e).$implicit;return d.oxw(4).handleContextEvent(t,i)}),d.YNc(1,ne,1,0,"div",31),d.TgZ(2,"div",32),d._UZ(3,"app-icon",33),d.qZA(),d.TgZ(4,"div",34),d.TgZ(5,"div",35),d.NdJ("modelChange",function(e){return t.$implicit.connected=e})("click",function(){const t=d.CHM(e).$implicit;return d.oxw(4).power(t)}),d.ALo(6,"async"),d.qZA(),d.qZA(),d.TgZ(7,"div",36),d.TgZ(8,"a",37),d.NdJ("contextmenu",function(e){return e.stopPropagation()}),d._uU(9),d.qZA(),d.YNc(10,se,2,1,"div",38),d.qZA(),d.TgZ(11,"div",24),d.TgZ(12,"mat-checkbox",39),d.NdJ("change",function(){const t=d.CHM(e).$implicit;return d.oxw(4).toggleDebug(t)}),d.ALo(13,"async"),d.TgZ(14,"span",40),d.ALo(15,"async"),d._uU(16),d.ALo(17,"async"),d.qZA(),d.qZA(),d.qZA(),d.TgZ(18,"div",41),d.YNc(19,oe,1,0,"app-icon",42),d.TgZ(20,"a",43),d._uU(21),d.qZA(),d.qZA(),d.TgZ(22,"div",44),d.TgZ(23,"button",45),d.NdJ("click",function(){const t=d.CHM(e).$implicit;return d.oxw(4).editModule(t)}),d._UZ(24,"app-icon",46),d.qZA(),d.TgZ(25,"button",47),d._UZ(26,"app-icon",46),d.qZA(),d.TgZ(27,"mat-menu",null,48),d.YNc(29,ae,4,2,"button",49),d.qZA(),d.qZA(),d.qZA()}if(2&e){const e=t.$implicit,i=t.index,n=d.MAs(28),s=d.oxw(4);d.Q6J("context-menu",n),d.xp6(5),d.ekj("bg-black",!e.running)("bg-error",e.running&&!e.connected)("bg-success",e.running&&!!e.connected),d.Q6J("sys",s.item.id)("mod",d.lcZ(6,25,s.bindings)[i])("model",e.connected),d.xp6(3),d.Q6J("routerLink",d.VKq(33,ce,e.id))("title",(null==e.driver?null:e.driver.name)||"<Unnamed>"),d.xp6(1),d.hij(" ",(null==e.driver?null:e.driver.name)||"<Unnamed>"," "),d.xp6(1),d.Q6J("ngIf",e.notes),d.xp6(2),d.Q6J("disabled",!e.running)("checked",d.lcZ(13,27,s.debugging)[e.id]),d.xp6(2),d.Q6J("title",d.lcZ(15,29,s.bindings)[i]),d.xp6(2),d.Oqu(d.lcZ(17,31,s.bindings)[i]),d.xp6(3),d.Q6J("ngIf",e.tls),d.xp6(1),d.Q6J("href",e.ip?(e.tls?"https://":"http://")+e.ip:e.uri,d.LSH),d.xp6(1),d.Oqu(e.ip||e.uri),d.xp6(3),d.Q6J("icon",d.DdM(35,re)),d.xp6(1),d.Q6J("matMenuTriggerFor",n),d.xp6(1),d.Q6J("icon",d.DdM(36,de)),d.xp6(3),d.Q6J("ngForOf",e.running?s.menu_options:s.offline_options)}}function me(e,t){if(1&e){const e=d.EpF();d.TgZ(0,"div",18),d.TgZ(1,"div",19),d._UZ(2,"div",20),d.TgZ(3,"div",20),d.SDv(4,21),d.qZA(),d.TgZ(5,"div",22),d.SDv(6,23),d.qZA(),d.TgZ(7,"div",24),d.SDv(8,25),d.qZA(),d.TgZ(9,"div",24),d.SDv(10,26),d.qZA(),d._UZ(11,"div",27),d.qZA(),d.TgZ(12,"div",28),d.NdJ("cdkDropListDropped",function(t){return d.CHM(e),d.oxw(3).drop(t)}),d.YNc(13,le,30,37,"div",29),d.ALo(14,"async"),d.qZA(),d.qZA()}if(2&e){const e=d.oxw(3);d.xp6(13),d.Q6J("ngForOf",d.lcZ(14,1,e.modules))}}function ge(e,t){if(1&e&&(d.ynx(0),d.YNc(1,me,15,3,"div",17),d.ALo(2,"async"),d.BQk()),2&e){const e=d.oxw(2),t=d.MAs(4);let i;d.xp6(1),d.Q6J("ngIf",null==(i=d.lcZ(2,2,e.modules))?null:i.length)("ngIfElse",t)}}function ue(e,t){if(1&e){const e=d.EpF();d.ynx(0),d.TgZ(1,"section",3),d.TgZ(2,"item-search-field",4),d.NdJ("ngModelChange",function(t){return d.CHM(e),d.oxw().new_module=t.id}),d.qZA(),d.TgZ(3,"button",5),d.NdJ("click",function(){return d.CHM(e),d.oxw().addModule()}),d.SDv(4,6),d.qZA(),d.TgZ(5,"button",7),d.NdJ("click",function(){return d.CHM(e),d.oxw().newModule()}),d.SDv(6,8),d.qZA(),d.qZA(),d.YNc(7,ie,4,1,"section",9),d.TgZ(8,"section",10),d.TgZ(9,"h3",11),d.SDv(10,12),d.qZA(),d.YNc(11,ge,3,4,"ng-container",13),d.ALo(12,"async"),d.qZA(),d.BQk()}if(2&e){const e=d.oxw(),t=d.MAs(2);d.xp6(2),d.Q6J("query_fn",e.query_fn)("exclude",e.exclude_fn)("ngModel",null),d.xp6(1),d.Q6J("disabled",!e.new_module),d.xp6(4),d.Q6J("ngIf",e.item.id&&e.item.modules&&!e.hide_exec),d.xp6(4),d.Q6J("ngIf",!d.lcZ(12,7,e.loading).modules)("ngIfElse",t)}}function fe(e,t){1&e&&(d.TgZ(0,"div",55),d._UZ(1,"mat-spinner",56),d.TgZ(2,"p"),d._uU(3,"Loading modules..."),d.qZA(),d.qZA()),2&e&&(d.xp6(1),d.Q6J("diameter",48))}function pe(e,t){1&e&&(d.TgZ(0,"div",55),d.TgZ(1,"p"),d._uU(2,"No devices for system"),d.qZA(),d.qZA())}let he=(()=>{class e extends c.K{constructor(e,t){super(),this._service=e,this._dialog=t,this.device_listener={},this.loading=this._service.loading,this.modules=this._service.modules,this.debugging=this._service.debug_state,this.bindings=this._service.module_bindings,this.menu_options=[{id:"power",name:"Toggle Power",icon:{type:"icon",class:"backoffice-power-plug"}},{id:"state",name:"View State",icon:{type:"icon",class:"backoffice-eye"}},{id:"reload",name:"Recompile Driver",icon:{type:"icon",class:"backoffice-cw"}},{id:"edit",name:"Edit Module",icon:{type:"icon",class:"backoffice-edit"}},{id:"remove",name:"Remove Module",icon:{type:"icon",class:"backoffice-trash"}},{id:"load",name:"Load Module",icon:{type:"icon",class:"backoffice-arrow-with-circle-up"}}],this.offline_options=[{id:"power",name:"Toggle Power",icon:{type:"icon",class:"backoffice-power-plug"}},{id:"edit",name:"Edit Module",icon:{type:"icon",class:"backoffice-edit"}},{id:"remove",name:"Remove Module",icon:{type:"icon",class:"backoffice-trash"}},{id:"load",name:"Load Module",icon:{type:"icon",class:"backoffice-arrow-with-circle-up"}}],this.query_fn=e=>(0,m.Ne_)({q:e}).pipe((0,h.U)(e=>e.data.map(e=>{var t;return Object.assign(Object.assign({},e),{extra:null===(t=e.driver)||void 0===t?void 0:t.name})}))),this.exclude_fn=e=>e.control_system_id===this.item.id||e.role===m.TAy.Logic,this.newModule=()=>this._service.newModule(),this.removeModule=e=>this._service.removeModule(e),this.editModule=e=>this._service.editModule(e),this.joinModule=e=>this._service.joinModule(e),this.reloadModule=e=>this._service.reloadModule(e),this.toggleDebug=e=>this._service.toggleModuleDebug(e),this.power=e=>{this._service.toggleModulePower(e),this.refresh_modules=!this.refresh_modules}}get item(){return this._service.active_item}handleContextEvent(e,t){if(e)switch(e.id){case"power":this.power(t);break;case"state":this.viewState(t);break;case"reload":this.reloadModule(t);break;case"remove":this.removeModule(t);break;case"load":this.loadModule(t);break;case"edit":this.editModule(t)}}reload(e){return(0,l.mG)(this,void 0,void 0,function*(){const t=yield(0,m.P8j)(e.id).toPromise();for(const i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})}viewState(e){return(0,l.mG)(this,void 0,void 0,function*(){const t=this._service.getModules();this._dialog.open(H.W,{data:{system:this.item,module:e,devices:t}})})}loadModule(e){(0,m.$yY)(e.id).toPromise().then(()=>(0,Z.t5)(`Successfully loaded module "${e.name||e.id}"`),e=>(0,Z.cB)(`Error loading module. Error: ${JSON.stringify(e.response||e.message||e)}`))}drop(e){e&&e.previousIndex!==e.currentIndex&&this._service.reorderModules(e.previousIndex,e.currentIndex)}addModule(){this.new_module&&(this.joinModule(this.new_module),this.new_module="")}}return e.\u0275fac=function(t){return new(t||e)(d.Y36(k),d.Y36(q.uw))},e.\u0275cmp=d.Xpm({type:e,selectors:[["system-modules"]],features:[d.qOj],decls:5,vars:1,consts:function(){let e,t,i,n,s,o,a,c;return e=$localize`:@@addExistingAction␟8f50eee9d9b0eebaeadd97255bc3e5dc1f095c30␟4161166080314782574: Add existing `,t=$localize`:@@newAction␟1f048f39d0b8565dc14a060ab7fa746e7f780f84␟778924775597593118: Add new `,i=$localize`:@@moduleListHeader␟e8eea559e7b48b6744ba5b97a5c7d4ee27ff7b4d␟2210018937903105246: Module List `,n=$localize`:@@execHeader␟9871d8fa856ba440ac531210821716ee279c9327␟2605526423196683591: Execute command `,s=$localize`:@@moduleStateLabel␟1fe7f352e3bc7356c77226a4d8404ee498b0c9e3␟4221055628112420738: State `,o=$localize`:@@moduleNameLabel␟0da9e5314dbb425c214c88ca2b0449f57c4ec264␟8751673256360811138: Name `,a=$localize`:@@moduleClassLabel␟854f0df0f6dd52d4c28d575977c6e7bd641e8458␟2482335949657196140: Class `,c=$localize`:@@moduleIpLabel␟e80fa953f9bca955499cd79cc853b0e1fd51cb32␟4332685056058298852: IP/URI `,[[4,"ngIf"],["load_state",""],["empty_state",""],["add-module","",1,"flex","space-x-2","flex-wrap","mb-2"],["name","module",1,"flex-grow-1","w-full","sm:flex-1","sm:w-auto","h-12",3,"query_fn","exclude","ngModel","ngModelChange"],["mat-button","",1,"flex-1","w-40","sm:w-32","sm:flex-none","h-11",3,"disabled","click"],e,["mat-button","",1,"flex-1","w-40","sm:w-32","sm:flex-none","h-11",3,"click"],t,["exec","","class","mb-2",4,"ngIf"],["device-list",""],[1,"font-medium","text-lg","mb-2"],i,[4,"ngIf","ngIfElse"],["exec","",1,"mb-2"],n,[3,"system"],["role","table","class","overflow-x-auto",4,"ngIf","ngIfElse"],["role","table",1,"overflow-x-auto"],["table-head",""],[1,"w-12","p-2"],s,[1,"flex-1","p-2"],o,[1,"w-48","p-2"],a,c,[1,"w-24","p-2","h-9"],["body","","cdkDropList","",1,"overflow-y-auto",3,"cdkDropListDropped"],["table-row","","cdkDrag","",3,"context-menu","contextAction",4,"ngFor","ngForOf"],["table-row","","cdkDrag","",3,"context-menu","contextAction"],["class","w-full h-10 border-2 border-dashed border-gray-600 bg-gray-300 bg-opacity-25",4,"cdkDragPlaceholder"],[1,"w-12","flex","justify-center","h-full","p-2",2,"cursor","grab"],["className","backoffice-select-arrows","cdkDragHandle",""],[1,"w-12","flex","items-center","justify-center","p-2","h-full"],["dot","","binding","","bind","connected",1,"h-4","w-4","rounded-full",3,"sys","mod","model","modelChange","click"],[1,"flex-1","p-2","h-full","flex","flex-col","justify-center"],[1,"truncate","underline","w-full",3,"routerLink","title","contextmenu"],["class","text-xs truncate w-full",4,"ngIf"],[1,"w-full",3,"disabled","checked","change"],[1,"truncate",3,"title"],[1,"w-48","text-right","flex","items-center","h-full","p-2"],["className","backoffice-lock",4,"ngIf"],["target","_blank",1,"truncate","underline",3,"href"],[1,"w-24","flex","px-2","justify-center"],["mat-icon-button","",3,"click"],[3,"icon"],["mat-icon-button","",3,"matMenuTriggerFor"],["menu","matMenu"],["mat-menu-item","",3,"click",4,"ngFor","ngForOf"],[1,"w-full","h-10","border-2","border-dashed","border-gray-600","bg-gray-300","bg-opacity-25"],[1,"text-xs","truncate","w-full"],["className","backoffice-lock"],["mat-menu-item","",3,"click"],[1,"text"],[1,"flex","flex-col","items-center","p-8","mx-auto"],[1,"mb-4",3,"diameter"]]},template:function(e,t){1&e&&(d.YNc(0,ue,13,9,"ng-container",0),d.YNc(1,fe,4,1,"ng-template",null,1,d.W1O),d.YNc(3,pe,3,0,"ng-template",null,2,d.W1O)),2&e&&d.Q6J("ngIf",t.item)},directives:[n.O5,V.y,s.JJ,s.On,J.lW,W.Q,a.Wj,n.sg,a.Zt,R.G,a.Hk,X.o,a.Bh,K.D,o.yS,ee.oG,te.p6,te.VK,te.OP,I.$g],pipes:[n.Ov],styles:["[_nghost-%COMP%]{padding:1rem}button[mat-button][_ngcontent-%COMP%]{min-width:8rem}button.mat-menu-item[_ngcontent-%COMP%]{display:flex;align-items:center}button[_ngcontent-%COMP%]   .text[_ngcontent-%COMP%]{margin-left:1rem}[role=table][_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{width:100%;min-width:48rem}.bg-success[_ngcontent-%COMP%]{height:.5rem!important;width:.5rem!important}[dot][_ngcontent-%COMP%]{transition:height .2s,width .2s}"]}),e})();var ve=i(6283),be=i(6756);const _e=function(e){return["/triggers",e]};function Ze(e,t){if(1&e){const e=d.EpF();d.TgZ(0,"div",22),d.TgZ(1,"i",23),d.NdJ("modelChange",function(t){const i=d.CHM(e).$implicit;return d.oxw(3).trigger_state[i.id]=t})("modelChange",function(){const t=d.CHM(e).$implicit;return d.oxw(3).updateComparisons(t.id)}),d.qZA(),d.TgZ(2,"div",24),d._UZ(3,"div",25),d.qZA(),d.TgZ(4,"div",12),d.TgZ(5,"a",26),d._uU(6),d.qZA(),d.qZA(),d.TgZ(7,"div",27),d._uU(8),d.qZA(),d.TgZ(9,"div",27),d._uU(10),d.qZA(),d.TgZ(11,"div",28),d._uU(12),d.ALo(13,"dateFrom"),d.qZA(),d.TgZ(14,"div",29),d.TgZ(15,"button",30),d.NdJ("click",function(){const t=d.CHM(e).$implicit;return d.oxw(3).copyWebhookURL(t)}),d._UZ(16,"app-icon",31),d.qZA(),d.TgZ(17,"button",30),d.NdJ("click",function(){const t=d.CHM(e).$implicit;return d.oxw(3).editTrigger(t)}),d._UZ(18,"app-icon",32),d.qZA(),d.TgZ(19,"button",30),d.NdJ("click",function(){const t=d.CHM(e).$implicit;return d.oxw(3).deleteTrigger(t)}),d._UZ(20,"app-icon",33),d.qZA(),d.qZA(),d.qZA()}if(2&e){const e=t.$implicit,i=d.oxw(3);d.xp6(1),d.Q6J("sys",i.item.id)("bind",e.id)("model",i.trigger_state[e.id]),d.xp6(2),d.ekj("bg-black",!(null!=i.trigger_state[e.id]&&i.trigger_state[e.id].triggered))("bg-success",null==i.trigger_state[e.id]?null:i.trigger_state[e.id].triggered),d.xp6(2),d.Q6J("routerLink",d.VKq(14,_e,e.id)),d.xp6(1),d.Oqu(e.name),d.xp6(2),d.hij(" ",null==i.trigger_state[e.id]?null:i.trigger_state[e.id].trigger_count," "),d.xp6(2),d.hij(" ",(null==i.trigger_state[e.id]?null:i.trigger_state[e.id].action_errors)+(null==i.trigger_state[e.id]?null:i.trigger_state[e.id].comparison_errors)||"0"," "),d.xp6(2),d.hij(" ",d.lcZ(13,12,1e3*+e.created_at)," ")}}function xe(e,t){if(1&e&&(d.TgZ(0,"div",9),d.TgZ(1,"div",10),d._UZ(2,"div",11),d.TgZ(3,"div",12),d.SDv(4,13),d.qZA(),d.TgZ(5,"div",14),d.SDv(6,15),d.qZA(),d.TgZ(7,"div",14),d.SDv(8,16),d.qZA(),d.TgZ(9,"div",17),d.SDv(10,18),d.qZA(),d._UZ(11,"div",19),d.qZA(),d.TgZ(12,"div",20),d.YNc(13,Ze,21,16,"div",21),d.ALo(14,"async"),d.qZA(),d.qZA()),2&e){const e=d.oxw(2);d.xp6(13),d.Q6J("ngForOf",d.lcZ(14,1,e.triggers))}}function ye(e,t){if(1&e&&(d.ynx(0),d.YNc(1,xe,15,3,"div",8),d.ALo(2,"async"),d.BQk()),2&e){const e=d.oxw(),t=d.MAs(12);let i;d.xp6(1),d.Q6J("ngIf",null==(i=d.lcZ(2,2,e.triggers))?null:i.length)("ngIfElse",t)}}function we(e,t){1&e&&(d.TgZ(0,"div",34),d._UZ(1,"mat-spinner",35),d.TgZ(2,"p"),d._uU(3,"Loading triggers..."),d.qZA(),d.qZA()),2&e&&(d.xp6(1),d.Q6J("diameter",48))}function Ae(e,t){1&e&&(d.TgZ(0,"div",34),d.TgZ(1,"p"),d._uU(2,"No triggers for system"),d.qZA(),d.qZA())}let Te=(()=>{class e{constructor(e){this._service=e,this.filter$=new g.X(""),this.loading=this._service.loading,this.trigger_state={},this.comparisons={},this.temp_trigger=new g.X(null),this.triggers=(0,u.aj)([this.filter$,this._service.triggers,this.temp_trigger]).pipe((0,h.U)(([e,t,i])=>{const n=e.toLowerCase(),s=(0,_.Tw)(i?[...t,i]:t,"id");return e?s.filter(e=>e.name.toLowerCase().includes(n)):s})),this.copyWebhookURL=e=>{(0,_.vQ)(`${location.origin}/api/engine/v2/webhook/${e.id}/notify?secret=${e.webhook_secret}`),(0,Z.QD)("Webhook link copied to clipboard")},this.editTrigger=e=>(0,l.mG)(this,void 0,void 0,function*(){return this.temp_trigger.next(yield this._service.editTrigger(e))}),this.deleteTrigger=e=>this._service.removeTrigger(e),this.selectTrigger=()=>(0,l.mG)(this,void 0,void 0,function*(){return this.temp_trigger.next((yield this._service.selectTrigger())||null)})}get item(){return this._service.active_item}updateComparisons(e){if(this.comparisons[e]="",this.trigger_state[e])for(const t in this.trigger_state[e].conditions)this.trigger_state[e].conditions.hasOwnProperty(t)&&(this.comparisons[e]&&(this.comparisons[e]+="\n"),this.comparisons[e]+=`${t}: ${this.trigger_state[e].conditions[t]}`)}}return e.\u0275fac=function(t){return new(t||e)(d.Y36(k))},e.\u0275cmp=d.Xpm({type:e,selectors:[["system-triggers"]],decls:13,vars:5,consts:function(){let e,t,i,n;return e=$localize`:@@nameLabel␟851d1ba79a56f7143fc04dbfed912dd2e40af5a9␟5635653058319830659: Name `,t=$localize`:@@triggerCountLabel␟d0ea4c946d36271ef5a7eea211009023e2889b7d␟3931882206009909445: Count `,i=$localize`:@@triggerErrorsLabel␟1fce9d65748a6c97d279c89a0fdbae43bbc57720␟966064976086561720: Errors `,n=$localize`:@@descriptionLabel␟f1b6540744a5b8ea6596fb6aad63773e1e57474c␟5939856475984736508: Added `,[[1,"flex","items-center","mb-4","space-x-2"],["mat-button","",2,"min-width","8rem",3,"click"],["appearance","outline",1,"h-12","flex-1"],["matPrefix","","className","backoffice-magnifying-glass text-xl mr-2"],["matInput","","placeholder","Filter triggers...",1,"rounded-none",3,"ngModel","ngModelChange"],[4,"ngIf","ngIfElse"],["load_state",""],["empty_state",""],["role","table","class","overflow-x-auto",4,"ngIf","ngIfElse"],["role","table",1,"overflow-x-auto"],["table-head",""],[1,"w-12","p-2"],["flex","",1,"flex-1","p-2"],e,[1,"w-16","p-2"],t,i,[1,"w-28","p-2"],n,[1,"w-32","p-2"],["table-body","",1,"overflow-y-auto"],["table-row","",4,"ngFor","ngForOf"],["table-row",""],["hidden","","binding","","mod","_TRIGGER__1",3,"sys","bind","model","modelChange"],[1,"w-12","flex","items-center","justify-center","h-full","p-2"],[1,"h-2","w-2","rounded-full"],[1,"truncate",3,"routerLink"],["desc","",1,"w-16","p-2"],["desc","",1,"w-28","p-2"],[1,"w-32","p-2","items-center","justify-center"],["mat-icon-button","",3,"click"],["className","backoffice-link"],["className","backoffice-edit"],["className","backoffice-trash"],[1,"flex","flex-col","items-center","p-8","mx-auto"],[1,"mb-4",3,"diameter"]]},template:function(e,t){if(1&e&&(d.TgZ(0,"section",0),d.TgZ(1,"button",1),d.NdJ("click",function(){return t.selectTrigger()}),d._uU(2," Add Trigger "),d.qZA(),d.TgZ(3,"mat-form-field",2),d._UZ(4,"app-icon",3),d.TgZ(5,"input",4),d.NdJ("ngModelChange",function(e){return t.filter$.next(e)}),d.qZA(),d.qZA(),d.qZA(),d.TgZ(6,"section"),d.YNc(7,ye,3,4,"ng-container",5),d.ALo(8,"async"),d.qZA(),d.YNc(9,we,4,1,"ng-template",null,6,d.W1O),d.YNc(11,Ae,3,0,"ng-template",null,7,d.W1O)),2&e){const e=d.MAs(10);d.xp6(5),d.Q6J("ngModel",""),d.xp6(2),d.Q6J("ngIf",!d.lcZ(8,3,t.loading).triggers)("ngIfElse",e)}},directives:[J.lW,ve.KE,X.o,ve.qo,be.Nt,s.Fj,s.JJ,s.On,n.O5,n.sg,K.D,o.yS,I.$g],pipes:[n.Ov,S.R],styles:["[_nghost-%COMP%]{height:100%;width:100%;padding:1rem}[flex][_ngcontent-%COMP%]{min-width:8rem}[role=table][_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{width:100%;min-width:36rem}"]}),e})();function qe(e,t){1&e&&d._UZ(0,"div",24)}function ke(e,t){if(1&e){const e=d.EpF();d.TgZ(0,"button",25),d.NdJ("click",function(){d.CHM(e);const t=d.oxw().$implicit;return d.oxw(3).removeZone(t)}),d._UZ(1,"app-icon",26),d.qZA()}}const Me=function(e){return["/zones",e]};function Oe(e,t){if(1&e&&(d.TgZ(0,"div",16),d.YNc(1,qe,1,0,"div",17),d.TgZ(2,"div",18),d._UZ(3,"app-icon",19),d.qZA(),d.TgZ(4,"div",9),d.TgZ(5,"a",20),d._uU(6),d.qZA(),d.qZA(),d.TgZ(7,"div",21),d._uU(8),d.qZA(),d.TgZ(9,"div",22),d.YNc(10,ke,2,0,"button",23),d.ALo(11,"async"),d.qZA(),d.qZA()),2&e){const e=t.$implicit,i=d.oxw(3);d.xp6(2),d.ekj("pointer-events-none",e.pending)("text-pending",e.pending),d.xp6(1),d.Q6J("className",e.pending?"backoffice-warning":"backoffice-select-arrows"),d.xp6(2),d.Q6J("routerLink",d.VKq(11,Me,e.id)),d.xp6(1),d.hij(" ",e.name," "),d.xp6(2),d.hij(" ",e.description," "),d.xp6(2),d.Q6J("ngIf",d.lcZ(11,9,i.zones).length>1)}}function Ne(e,t){if(1&e){const e=d.EpF();d.TgZ(0,"div",6),d.TgZ(1,"div",7),d._UZ(2,"div",8),d.TgZ(3,"div",9),d.SDv(4,10),d.qZA(),d.TgZ(5,"div",11),d.SDv(6,12),d.qZA(),d._UZ(7,"div",13),d.qZA(),d.TgZ(8,"div",14),d.NdJ("cdkDropListDropped",function(t){return d.CHM(e),d.oxw(2).drop(t)}),d.YNc(9,Oe,12,13,"div",15),d.ALo(10,"async"),d.qZA(),d.qZA()}if(2&e){const e=d.oxw(2);d.xp6(9),d.Q6J("ngForOf",d.lcZ(10,1,e.zones))}}function Je(e,t){if(1&e&&(d.ynx(0),d.YNc(1,Ne,11,3,"div",5),d.ALo(2,"async"),d.BQk()),2&e){const e=d.oxw();let t;d.xp6(1),d.Q6J("ngIf",null==(t=d.lcZ(2,1,e.zones))?null:t.length)}}function $e(e,t){1&e&&(d.TgZ(0,"div",27),d._UZ(1,"mat-spinner",28),d.TgZ(2,"p"),d._uU(3,"Loading zones..."),d.qZA(),d.qZA()),2&e&&(d.xp6(1),d.Q6J("diameter",48))}let Ie=(()=>{class e{constructor(e){this._service=e,this.pending_zones=new g.X([]),this.loading=this._service.loading,this.zones=(0,u.aj)([this._service.zones,this.pending_zones]).pipe((0,h.U)(([e,t])=>[...e,...t.map(e=>Object.assign(Object.assign({},e),{pending:!0}))])),this.query_fn=e=>(0,m.I0G)({q:e}).pipe((0,h.U)(e=>e.data)),this.exclude_fn=e=>this.item.zones.indexOf(e.id)>=0,this.removeZone=e=>e.pending?this.pending_zones.next(this.pending_zones.getValue().filter(t=>t.id!==e.id)):this._service.removeZone(e),this.addPendingZone=e=>this.pending_zones.next([...this.pending_zones.getValue(),e]),this.savePendingZones=()=>(0,l.mG)(this,void 0,void 0,function*(){this.pending_zones.getValue().length&&(yield this._service.addZones(this.pending_zones.getValue()),this.pending_zones.next([]))})}get item(){return this._service.active_item}drop(e){e&&e.previousIndex!==e.currentIndex&&this._service.reorderZones(e.previousIndex,e.currentIndex)}}return e.\u0275fac=function(t){return new(t||e)(d.Y36(k))},e.\u0275cmp=d.Xpm({type:e,selectors:[["system-zones"]],decls:9,vars:8,consts:function(){let e,t;return e=$localize`:@@nameLabel␟cff1428d10d59d14e45edec3c735a27b5482db59␟8953033926734869941:Name`,t=$localize`:@@descriptionLabel␟0f2005f864307f35fc334cb58b20a28b2af7af84␟4993784719124887635: Description `,[[1,"flex","items-center","space-x-2","mb-4"],["name","zone",1,"flex-1","h-12",3,"query_fn","exclude","ngModel","ngModelChange"],["mat-button","",3,"disabled","click"],[4,"ngIf","ngIfElse"],["load_state",""],["role","table","class","overflow-x-auto",4,"ngIf"],["role","table",1,"overflow-x-auto"],["table-head",""],[1,"w-12","p-2"],[1,"w-48","p-2"],e,["desc","",1,"flex-1","p-2"],t,[1,"w-16","p-2"],["body","","cdkDropList","",1,"overflow-y-auto",3,"cdkDropListDropped"],["table-row","","cdkDrag","",4,"ngFor","ngForOf"],["table-row","","cdkDrag",""],["class","w-full h-10 border-2 border-dashed border-gray-600 bg-gray-300 bg-opacity-25",4,"cdkDragPlaceholder"],[1,"w-12","flex","justify-center","h-full","p-2",2,"cursor","grab"],["cdkDragHandle","",3,"className"],[3,"routerLink"],["desc","",1,"flex-1","truncate"],[1,"w-16","p-2","items-center","justify-center"],["mat-icon-button","",3,"click",4,"ngIf"],[1,"w-full","h-10","border-2","border-dashed","border-gray-600","bg-gray-300","bg-opacity-25"],["mat-icon-button","",3,"click"],["className","backoffice-trash"],[1,"flex","flex-col","items-center","p-8","mx-auto"],[1,"mb-4",3,"diameter"]]},template:function(e,t){if(1&e&&(d.TgZ(0,"section",0),d.TgZ(1,"item-search-field",1),d.NdJ("ngModelChange",function(e){return t.addPendingZone(e)}),d.qZA(),d.TgZ(2,"button",2),d.NdJ("click",function(){return t.savePendingZones()}),d._uU(3," Save Pending "),d.qZA(),d.qZA(),d.TgZ(4,"section"),d.YNc(5,Je,3,3,"ng-container",3),d.ALo(6,"async"),d.qZA(),d.YNc(7,$e,4,1,"ng-template",null,4,d.W1O)),2&e){const e=d.MAs(8);d.xp6(1),d.Q6J("query_fn",t.query_fn)("exclude",t.exclude_fn)("ngModel",null),d.xp6(1),d.Q6J("disabled",!t.pending_zones.getValue().length),d.xp6(3),d.Q6J("ngIf",!d.lcZ(6,6,t.loading).zones)("ngIfElse",e)}},directives:[V.y,s.JJ,s.On,J.lW,n.O5,a.Wj,n.sg,a.Zt,a.Hk,X.o,a.Bh,o.yS,I.$g],pipes:[n.Ov],styles:["[_nghost-%COMP%]{height:100%;width:100%;padding:1rem}[desc][_ngcontent-%COMP%]{min-width:8rem}"]}),e})();var Se=i(2187),Ce=i(8256),ze=i(3049),Ue=i(7486),Pe=i(5001),je=i(6828),Le=i(6402);function Qe(e,t){if(1&e){const e=d.EpF();d.TgZ(0,"button",19),d.NdJ("click",function(e){return e.stopPropagation()})("click",function(){d.CHM(e);const t=d.oxw(3).$implicit;return d.oxw(3).saveMetadata(t)}),d.SDv(1,20),d.qZA()}}function Ee(e,t){if(1&e&&(d.ynx(0),d.YNc(1,Qe,2,0,"button",18),d.BQk()),2&e){const e=d.oxw(2).$implicit,t=d.oxw(3),i=d.MAs(4);d.xp6(1),d.Q6J("ngIf",!t.loading[e.name])("ngIfElse",i)}}const De=function(){return{class:"backoffice-trash"}};function Ye(e,t){if(1&e){const e=d.EpF();d.TgZ(0,"div",21),d.TgZ(1,"button",22),d.NdJ("click",function(){d.CHM(e);const t=d.oxw(2).$implicit;return d.oxw(3).deleteMetadata(t.name)}),d._UZ(2,"app-icon",14),d.qZA(),d.qZA()}2&e&&(d.xp6(2),d.Q6J("icon",d.DdM(1,De)))}const Fe=function(){return{class:"backoffice-edit"}};function Ge(e,t){if(1&e){const e=d.EpF();d.TgZ(0,"mat-expansion-panel",10),d.TgZ(1,"mat-expansion-panel-header"),d.TgZ(2,"mat-panel-title"),d.TgZ(3,"div",11),d._uU(4),d.qZA(),d.YNc(5,Ee,2,2,"ng-container",12),d.TgZ(6,"button",13),d.NdJ("click",function(t){d.CHM(e);const i=d.oxw().$implicit;return d.oxw(3).editMetadataDetails(i),t.stopPropagation()}),d._UZ(7,"app-icon",14),d.qZA(),d.YNc(8,Ye,3,2,"div",15),d.qZA(),d.qZA(),d.TgZ(9,"div",16),d._UZ(10,"settings-form-field",17),d.qZA(),d.qZA()}if(2&e){const e=d.oxw().$implicit,t=d.oxw(3);d.ekj("no-padding",!0),d.Q6J("formGroup",t.form_map[e.name]),d.xp6(4),d.hij(" ",t.form_map[e.name].controls.name.value," "),d.xp6(1),d.Q6J("ngIf",t.edited[e.name]),d.xp6(2),d.Q6J("icon",d.DdM(9,Fe)),d.xp6(1),d.Q6J("ngIf",!e.new),d.xp6(2),d.Q6J("schema",t.schema_map[e.name])("readonly",!1)}}function Be(e,t){if(1&e&&(d.ynx(0),d.YNc(1,Ge,11,10,"mat-expansion-panel",9),d.BQk()),2&e){const e=t.$implicit,i=d.oxw(3);d.xp6(1),d.Q6J("ngIf",i.form_map[e.name])}}function He(e,t){if(1&e&&(d.TgZ(0,"div",7),d.TgZ(1,"mat-accordion"),d.YNc(2,Be,2,1,"ng-container",8),d.qZA(),d.qZA()),2&e){const e=d.oxw(2);d.xp6(2),d.Q6J("ngForOf",e.metadata)}}function Ve(e,t){if(1&e){const e=d.EpF();d.TgZ(0,"div",3),d.TgZ(1,"button",4),d.NdJ("click",function(){return d.CHM(e),d.oxw().newMetadata()}),d.SDv(2,5),d.qZA(),d.YNc(3,He,3,1,"div",6),d.qZA()}if(2&e){const e=d.oxw(),t=d.MAs(2);d.xp6(3),d.Q6J("ngIf",e.metadata&&e.metadata.length>0)("ngIfElse",t)}}function We(e,t){1&e&&(d.TgZ(0,"div",23),d.TgZ(1,"div",24),d.SDv(2,25),d.qZA(),d.qZA())}function Re(e,t){1&e&&d._UZ(0,"mat-spinner",26)}let Xe=(()=>{class e extends c.K{constructor(e,t,i){super(),this._dialog=e,this._service=t,this._schemas=i,this.metadata=[],this.form_map={},this.edited={},this.loading={},this.schema_map={}}get item(){return this._service.active_item}validateName(e){return t=>e.indexOf(t.value)>=0?{name:!0}:null}ngOnInit(){this.subscription("item",this._service.item.subscribe(e=>{this.loadMetadata()}))}newMetadata(){this.metadata.push({name:`new_field_${Math.floor(999999999*Math.random())}`,description:"",new:!0,details:{}}),this.generateForms()}editMetadataDetails(e){this._dialog.open(Ce.v,{maxWidth:"95vw",data:{form:this.form_map[e.name]}})}deleteMetadata(e){const t=this._dialog.open(ze.z,Object.assign(Object.assign({},ze.t),{data:{title:"Kill process",content:`\n                    <p>Are you sure you want delete the metadata property "${e}"?</p>\n                `,icon:{type:"icon",class:"backoffice-trash"}}}));this.subscription("confirm",t.componentInstance.event.subscribe(i=>{"done"===i.reason&&(0,m._p1)(this.item.id,{name:e}).subscribe(()=>{(0,Z.t5)(`Successfully removed "${e}" metadata.`),this.metadata=this.metadata.filter(t=>t.name!==e),this.generateForms()},t=>(0,Z.cB)(`Error removing old "${e}" metadata. Error: ${t.response||t.message||t}`)),t.close()}))}saveMetadata(e){const t=this.form_map[e.name];if(t.markAllAsTouched(),!t.valid)return(0,Z.cB)(`JSON for property "${t.controls.name.value}" is invalid`);const i=t.value;this.loading[e.name]=!0,(0,m.Ymr)(this.item.id,Object.assign(Object.assign({},i),{details:JSON.parse(i.details)})).subscribe(t=>{this.loading[e.name]=!1;const n=this.metadata.findIndex(t=>t.name===e.name);this.edited[e.name]=!1,e.name!==t.name&&(0,m._p1)(this.item.id,e).toPromise().catch(t=>(0,Z.cB)(`Error removing old "${e.name}" metadata. Error: ${JSON.stringify(t.response||t.message||t)}`)),n>=0&&this.metadata.splice(n,1,Object.assign(Object.assign({},t),{new:!1})),(0,Z.t5)(`Saved "${i.name}" metadata.`),this.generateForms()},t=>{this.loading[e.name]=!1,(0,Z.cB)(`Error saving "${i.name}" metadata. Error: ${JSON.stringify(t.response||t.message||t)}`)})}generateForms(){delete this.form_map,this.form_map={},this.metadata.forEach(e=>{const t="string"==typeof e.details?JSON.parse(e.details):e.details;this.form_map[e.name]=new s.cw({name:new s.NI(e.name,[s.kI.required,this.validateName(this.metadata.filter(t=>t.name!==e.name).map(e=>e.name))]),description:new s.NI(e.description),editors:new s.NI(e.editors),details:new s.NI(JSON.stringify(t||{},void 0,4),[s.kI.required,Se.NS]),schema:new s.NI(e.schema)}),this.subscription(`${e.name}_changes`,this.form_map[e.name].valueChanges.subscribe(()=>this.edited[e.name]=!0)),this.subscription(`${e.name}_schema`,this.form_map[e.name].controls.schema.valueChanges.subscribe(t=>{let i=this._schemas.getSchema(t);if(!i)try{i=JSON.parse(t)}catch(n){i={}}this.schema_map[e.name]=i}))})}loadMetadata(){(0,m.Eio)(this.item.id).subscribe(e=>{this.metadata=Object.keys(e).map(t=>e[t]),this.generateForms()})}}return e.\u0275fac=function(t){return new(t||e)(d.Y36(q.uw),d.Y36(A.L),d.Y36(Ue.O))},e.\u0275cmp=d.Xpm({type:e,selectors:[["system-metadata"]],features:[d.qOj],decls:5,vars:1,consts:function(){let e,t,i;return e=$localize`:@@addMetadataAction␟21539c364f82b6b766d912c3734a014cb30f27a9␟6503325999299484981: Add new Metadata Field `,t=$localize`:@@saveAction␟baa3a276f05a6226cb663918714882c53b84da34␟25086637338905953: Save `,i=$localize`:@@zoneMetadataEmpty␟9efcb2e7d3516841bad5ea1dadad17ecbf398ef1␟8996986316640896080: No zone metadata found `,[["class","p-4",4,"ngIf"],["empty_state",""],["load_state",""],[1,"p-4"],["mat-button","",3,"click"],e,["class","mt-4",4,"ngIf","ngIfElse"],[1,"mt-4"],[4,"ngFor","ngForOf"],[3,"no-padding","formGroup",4,"ngIf"],[3,"formGroup"],["edit","",1,"flex-1"],[4,"ngIf"],["mat-icon-button","","matTooltip","Edit Metadata Settings",3,"click"],[3,"icon"],["class","contents",4,"ngIf"],[1,"settings"],["formControlName","details","lang","json",3,"schema","readonly"],["mat-button","","save","",3,"click",4,"ngIf","ngIfElse"],["mat-button","","save","",3,"click"],t,[1,"contents"],["mat-icon-button","","matTooltip","Remove Metadata",3,"click"],[1,"info-block"],[1,"text"],i,["diameter","32"]]},template:function(e,t){1&e&&(d.YNc(0,Ve,4,2,"div",0),d.YNc(1,We,3,0,"ng-template",null,1,d.W1O),d.YNc(3,Re,1,0,"ng-template",null,2,d.W1O)),2&e&&d.Q6J("ngIf",t.item)},directives:[n.O5,J.lW,Pe.pp,n.sg,Pe.ib,s.JL,s.sg,Pe.yz,Pe.yK,je.gM,X.o,Le.x,s.JJ,s.u,I.$g],styles:["[edit][_ngcontent-%COMP%]   app-icon[_ngcontent-%COMP%]{opacity:0;transition:opacity .2s}[edit][_ngcontent-%COMP%]:hover   app-icon[_ngcontent-%COMP%]{opacity:1}mat-panel-title[_ngcontent-%COMP%]{display:flex;align-items:center;height:1.2em;overflow:visible}mat-panel-title[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{font-size:.8em;background:none;border:none;text-decoration:underline;color:inherit}mat-form-field[_ngcontent-%COMP%]{height:3em}.settings[_ngcontent-%COMP%]{width:100%}.contents[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;flex:1;min-width:2em}.contents[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{text-decoration:none}"]}),e})();var Ke=i(3511),et=i(9858);const tt=[{path:":id",component:N,children:[{path:"",redirectTo:"about"},{path:"about",component:B},{path:"modules",component:he},{path:"triggers",component:Te},{path:"zones",component:Ie},{path:"metadata",component:Xe},{path:"extend/:id",component:Ke.z},{path:"history",component:et.D},{path:"**",redirectTo:"about"}]},{path:"**",redirectTo:"-"}];var it=i(7561);let nt=(()=>{class e{}return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=d.oAB({type:e}),e.\u0275inj=d.cJS({imports:[[n.ez,s.u5,s.UX,o.Bz.forChild(tt),it.X,a._t]]}),e})()}}]);
//# sourceMappingURL=389.71513f7e9afabec800db.js.map