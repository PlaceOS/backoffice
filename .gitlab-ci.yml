image: registry.gitlab.com/aca-engine/frontend-base/ngx-backoffice:latest

stages:
    - test
    - build
    - deploy

# Cache node modules for future runs
cache: &global_cache
    key: aca-general-angular-cache
    paths:
        - node_modules
        - package-lock.old.json

variables:
    DOCKER_DRIVER: overlay2
    DEMO_ROUTE: '/demo/aca/backoffice/'
    DEPLOY_FOLDER: 'backoffice'
    DEPLOY_REPO_PATH: 'gitlab.com/aca-engine/deploy/www-template.git'

before_script:
    - BRANCH=$CI_COMMIT_REF_NAME
    - GIT_USER=$GITLAB_USER_NAME
    - GIT_EMAIL=$GITLAB_USER_EMAIL
    - export BRANCH
    - export GIT_USER
    - export GIT_EMAIL
    # Set GIT user to the commit user
    - git config --global user.name $GIT_USER
    - git config --global user.email $GIT_EMAIL
    - git remote set-url origin https://$GITLAB_TOKEN@gitlab.com/$CI_PROJECT_PATH.git
    - /bin/sh ./scripts/install-dependencies.sh

# Add versioning details build from semantic release
versioned_build:
    stage: build
    cache:
        <<: *global_cache
        policy: pull
    only:
        - master
    except:
        - tags
    artifacts:
        paths:
            - dist/
    script:
        - npm run semantic-release
        - /bin/sh ./scripts/build-with-version-tag.sh

# Standalone build of the application
build_app:
    stage: build
    cache:
        <<: *global_cache
        policy: pull
    script:
        - ./node_modules/.bin/gulp build --prod --aot
    artifacts:
        paths:
            - dist/
    except:
        - master
        - tags

# Run tests for the application
test_app:
    stage: test
    script:
        - npm run test:ci
    except:
        - tags

# Deploy demo build of the latest version
deploy_demo:
    stage: deploy
    cache:
        <<: *global_cache
        policy: pull
    only:
        - merge_requests
    script:
        - /bin/sh ./scripts/build-demo.sh

# Deploy build of the latest version
deploy_app:
    stage: deploy
    variables:
        CACHE: 'false'
    cache: {}
    only:
        - master
        - develop
    script:
        - /bin/sh ./scripts/deploy.sh
    except:
        - tags
