{"version":3,"mappings":"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","names":["DriversComponent","BaseClass","constructor","_service","super","this","show_options","extensions","extensionsForItem","active_item","name","updateTabList","tab_list","id","icon","class","count","device_count","concat","ngOnInit","subscription","item","subscribe","loadValues","query","offset","limit","driver_id","queryModules","toPromise","total","i0","selectors","DriverStateService","_state","_dialog","BehaviorSubject","_loading","asObservable","_last_error","pipe","filter","d","PlaceDriver","switchMap","driver","isDriverCompiled","catchError","_","__awaiter","err","o","json","next","r","compilation_output","console","log","retryWhen","delay","tap","details","map","data","shareReplay","viewError","error","getValue","open","ViewResponseModalComponent","title","content","recompileDriver","openConfirmModal","type","reason","close","loading","success","catch","notifyError","notifySuccess","removeModule","device","system","removeSystemModule","statusText","message","replaceItem","factory","ctx_r7","DriverAboutComponent","is_compiled","last_error","$localize","ctx","ctx_r17","oxw","ctx_r19","DriverModulesComponent","combineLatest","filter$","modules","filters","search","toLowerCase","mod","includes","custom_name","loadSystems","loading_systems","systems","querySystems","module_id","ROUTES","path","component","children","ExtensionOutletComponent","SettingsHistoryViewComponent","redirectTo","AppDriversModule","CommonModule","FormsModule","RouterModule","SharedContentModule"],"sources":["./apps/backoffice/src/app/drivers/drivers.component.ts","./apps/backoffice/src/app/drivers/driver-state.service.ts","./apps/backoffice/src/app/drivers/driver-about.component.ts","./apps/backoffice/src/app/drivers/driver-devices.component.ts","./apps/backoffice/src/app/drivers/drivers.routes.ts","./apps/backoffice/src/app/drivers/drivers.module.ts"],"sourcesContent":["import { Component } from '@angular/core';\nimport { PlaceDriver, queryModules } from '@placeos/ts-client';\n\nimport { ActiveItemService } from '../common/item.service';\nimport { BaseClass } from '../common/base.class';\nimport { extensionsForItem } from '../common/api';\n\n@Component({\n    selector: 'app-drivers',\n    template: `\n        <div\n            class=\"flex-1 flex-col sm:flex-row flex h-full w-full relative\"\n        >\n            <sidebar\n                heading=\"Drivers\"\n                name=\"drivers\"\n                class=\"absolute top-0 left-0 h-12 w-full sm:h-full sm:static\"\n            ></sidebar>\n            <item-display\n                name=\"driver\"\n                route=\"drivers\"\n                [tabs]=\"tab_list\"\n                class=\"flex-1 relative mt-12 sm:mt-0 w-full sm:w-1/2\"\n            ></item-display>\n        </div>\n    `,\n    styles: [\n        `\n            sidebar {\n                transition: height 300ms;\n            }\n            @media screen and (min-width: 640px) {\n                sidebar {\n                    width: 20em !important;\n                }\n            }\n        `,\n    ],\n})\nexport class DriversComponent extends BaseClass {\n    /** Number of devices for the active system */\n    public device_count: number;\n\n    public readonly name = 'drivers';\n\n    public readonly show_options = this._service.show_options;\n\n    public tab_list = [];\n\n    public get extensions() {\n        return extensionsForItem(this._service.active_item, this.name);\n    }\n\n    public updateTabList() {\n        this.tab_list = [\n            { id: 'about', name: 'About', icon: { class: 'backoffice-info-with-circle' } },\n            { id: 'modules', name: 'Modules', count: this.device_count, icon: { class: 'backoffice-tablet' } },\n            { id: 'history', name: 'Settings History', icon: { class: 'backoffice-clock' } },\n\n        ].concat(this.extensions);\n    }\n\n    constructor(protected _service: ActiveItemService) {\n        super();\n    }\n\n    public ngOnInit(): void {\n        this.subscription('item', this._service.item.subscribe((item) => {\n            this.loadValues(item as any);\n            this.updateTabList();\n        }));\n        this.updateTabList();\n    }\n\n    protected async loadValues(item: PlaceDriver) {\n        if (!item) return;\n        const query: any = { offset: 0, limit: 1, driver_id: item.id };\n        this.device_count = (await queryModules(query).toPromise()).total;\n    }\n}\n","import { Injectable } from '@angular/core';\nimport { MatDialog } from '@angular/material/dialog';\nimport {\n    isDriverCompiled,\n    PlaceDriver,\n    PlaceModule,\n    queryModules,\n    recompileDriver,\n    removeSystemModule,\n} from '@placeos/ts-client';\nimport { BehaviorSubject, throwError } from 'rxjs';\nimport {\n    catchError,\n    delay,\n    filter,\n    map,\n    retryWhen,\n    shareReplay,\n    switchMap,\n    tap,\n} from 'rxjs/operators';\nimport { openConfirmModal } from '../common/general';\nimport { ActiveItemService } from '../common/item.service';\nimport { notifyError, notifySuccess } from '../common/notifications';\nimport { HashMap } from '../common/types';\nimport { ViewResponseModalComponent } from '../overlays/view-response-modal/view-response-modal.component';\n\n@Injectable({\n    providedIn: 'root',\n})\nexport class DriverStateService {\n    private _loading = new BehaviorSubject<boolean>(false);\n    private _last_error = new BehaviorSubject<HashMap>(null);\n\n    public readonly item = this._state.item;\n\n    public readonly loading = this._loading.asObservable();\n\n    public readonly last_error = this._last_error.asObservable();\n\n    public readonly is_compiled = this.item.pipe(\n        filter((d) => !!d && d instanceof PlaceDriver),\n        switchMap((driver) => isDriverCompiled(driver.id)),\n        catchError(async (_: Response) => {\n            const err = await _?.json();\n            this._last_error.next(err?.compilation_output || _);\n            console.log('Driver Error:', err);\n            if (!err?.compilation_output) throw _;\n        }),\n        retryWhen(delay(1000)),\n        tap(_ => _ ? this._last_error.next(null) : '')\n    );\n\n    public readonly modules = this.item.pipe(\n        switchMap(async (item) => {\n            this._loading.next(true);\n            const details = await queryModules({ driver_id: item.id }).toPromise();\n            this._loading.next(false);\n            return details;\n        }),\n        map((d) => d.data),\n        shareReplay()\n    );\n\n    public get active_item() {\n        return this._state.active_item;\n    }\n\n    constructor(private _state: ActiveItemService, private _dialog: MatDialog) {\n        this.item.subscribe(() => this._last_error.next(null));\n    }\n\n    public viewError() {\n        const error = this._last_error.getValue();\n        if (!error) return;\n        this._dialog.open<ViewResponseModalComponent>(ViewResponseModalComponent, {\n            data: { title: 'Driver Compilation Error', content: error },\n        });\n    }\n\n    public async recompileDriver() {\n        const details = await openConfirmModal(\n            {\n                title: `Recompile Driver`,\n                content: `<p>Are you sure you want recompile this driver?</p><p>New driver code will be loaded and device settings will be updated.</p>`,\n                icon: { type: 'icon', class: 'backoffice-cycle' },\n            },\n            this._dialog\n        );\n        if (!details || !details.reason) return details.close();\n        details.loading('Recompiling driver...');\n        const success = await recompileDriver(this._state.active_item.id)\n            .toPromise()\n            .catch((_) => null);\n        details.close();\n        if (!success) return notifyError('Failed to recompiled driver.');\n        notifySuccess('Successfully recompiled driver.');\n    }\n\n    public async removeModule(device: PlaceModule) {\n        const details = await openConfirmModal(\n            {\n                title: 'Remove module?',\n                content: `Remove ${device.driver_id}?<br>All associated data be deleted immediatedly.`,\n                icon: { type: 'icon', class: 'backoffice-trash' },\n            },\n            this._dialog\n        );\n        if (!details || !details.reason) return;\n        const system = await removeSystemModule(this.active_item.id, device.id)\n            .toPromise()\n            .catch((err) => {\n                notifyError(\n                    `Error removing module ${device.id}. Error: ${\n                        err.statusText || err.message || err\n                    }`\n                );\n            });\n        details.close();\n        if (!system) return;\n        this._state.replaceItem(system);\n        notifySuccess(`Successfully removed module.`);\n    }\n}\n","import { Component } from '@angular/core';\nimport { PlaceDriver } from '@placeos/ts-client';\nimport { DriverStateService } from './driver-state.service';\n\n\n@Component({\n    selector: 'driver-about',\n    template: `\n        <section class=\"mb-4 space-y-2\">\n            <div class=\"flex items-center space-x-2\" *ngIf=\"item.default_uri\">\n                <label i18n=\"@@driverDefaultURILabel\">Default URI:</label>\n                <div class=\"value\">{{ item.default_uri }}</div>\n            </div>\n            <div class=\"flex items-center space-x-2\" *ngIf=\"item.default_port\">\n                <label i18n=\"@@driverDefaultPortLabel\"\n                    >Default Port Number:</label\n                >\n                <div class=\"value\">{{ item.default_port }}</div>\n            </div>\n            <div class=\"flex items-center space-x-2\">\n                <label i18n=\"@@driverDetailsCompiled\">Compiled:</label>\n                <div class=\"value\">\n                    {{ (compiled | async) ? 'true' : 'false' }}\n                </div>\n                <mat-spinner\n                    diameter=\"24\"\n                    *ngIf=\"!(compiled | async)\"\n                ></mat-spinner>\n                <button\n                    mat-button\n                    *ngIf=\"compilation_error | async\"\n                    (click)=\"viewErrors()\"\n                >\n                    View Errors\n                </button>\n            </div>\n            <div class=\"flex items-center space-x-2\">\n                <label i18n=\"@@driverDetailsCommit\">Repository:</label>\n                <div class=\"value\">\n                    <a\n                        [routerLink]=\"[\n                            '/repositories',\n                            item.repository_id,\n                            'about'\n                        ]\"\n                        class=\"underline\"\n                    >\n                        {{ item.repository_id }}</a\n                    >\n                </div>\n            </div>\n            <div class=\"flex items-center space-x-2\">\n                <label i18n=\"@@driverDetailsCommit\">Commit:</label>\n                <div class=\"value\">{{ item.commit }}</div>\n            </div>\n            <div class=\"flex items-center space-x-2\">\n                <label i18n=\"@@driverDetailsFileName\">File Name:</label>\n                <div class=\"value\">{{ item.file_name }}</div>\n            </div>\n            <div class=\"flex items-center space-x-2\">\n                <label i18n=\"@@driverDetailsModuleName\">Module Name:</label>\n                <div class=\"value\">{{ item?.module_name }}</div>\n            </div>\n            <div class=\"flex items-center space-x-2\">\n                <label i18n=\"@@driverCreatedAtLabel\">Created:</label>\n                <div class=\"value\">{{ item.created_at * 1000 | dateFrom }}</div>\n            </div>\n            <div class=\"flex items-center space-x-2\">\n                <label i18n=\"@@driverUpdatedAtLabel\">Updated:</label>\n                <div class=\"value\">{{ item.updated_at * 1000 | dateFrom }}</div>\n            </div>\n        </section>\n        <section>\n            <button\n                mat-button\n                (click)=\"recompileDriver()\"\n                i18n=\"@@driverReloadAction\"\n            >\n                Recompile Driver\n            </button>\n        </section>\n        <hr class=\"my-4\" />\n        <header class=\"font-medium text-lg\" i18n=\"@@settingsLabel\">\n            Settings\n        </header>\n        <section *ngIf=\"item.settings; else load_state\">\n            <a-settings-form\n                [merge]=\"true\"\n                [id]=\"item.id\"\n                [settings]=\"item.settings\"\n            ></a-settings-form>\n        </section>\n        <ng-template #load_state>\n            <div class=\"flex flex-col items-center justify-center\">\n                <mat-spinner class=\"mb-4\" diameter=\"48\"></mat-spinner>\n                <p i18n=\"@@driverLoadingLabel\">Loading driver settings...</p>\n            </div>\n        </ng-template>\n    `,\n    styles: [\n        `\n            :host {\n                padding: 1rem;\n                height: 100%;\n                width: 100%;\n            }\n        `,\n    ],\n})\nexport class DriverAboutComponent {\n    public readonly compiled = this._service.is_compiled;\n    public readonly compilation_error = this._service.last_error;\n\n    public readonly recompileDriver = () => this._service.recompileDriver();\n    public readonly viewErrors = () => this._service.viewError();\n\n    public get item(): PlaceDriver {\n        return (this._service.active_item || {}) as any;\n    }\n\n    constructor(private _service: DriverStateService) {}\n}\n","import { Component } from '@angular/core';\nimport { BehaviorSubject, combineLatest } from 'rxjs';\nimport { map } from 'rxjs/operators';\n\nimport { BaseClass } from 'apps/backoffice/src/app/common/base.class';\nimport { DriverStateService } from './driver-state.service';\nimport { HashMap } from '@placeos/ts-client/dist/esm/utilities/types';\nimport { PlaceModule, PlaceSystem, querySystems } from '@placeos/ts-client';\n\n@Component({\n    selector: 'driver-devices',\n    template: `\n        <section class=\"flex items-center mb-4\">\n            <mat-form-field appearance=\"outline\" class=\"h-12 flex-1\">\n                <app-icon\n                    matPrefix\n                    className=\"backoffice-magnifying-glass text-xl mr-2\"\n                ></app-icon>\n                <input\n                    [ngModel]=\"''\"\n                    (ngModelChange)=\"filter$.next($event)\"\n                    matInput\n                    placeholder=\"Filter Devices...\"\n                    class=\"rounded-none\"\n                />\n            </mat-form-field>\n        </section>\n        <section>\n            <div\n                role=\"table\"\n                class=\"overflow-x-auto\"\n                *ngIf=\"(modules | async)?.length; else empty_state\"\n            >\n                <div table-head>\n                    <div class=\"w-12 p-2\">State</div>\n                    <div flex class=\"flex-1 p-2\" i18n=\"@@nameLabel\">Name</div>\n                    <div class=\"w-24 p-2\"></div>\n                </div>\n                <div table-body class=\"overflow-y-auto\">\n                    <div\n                        table-row\n                        *ngFor=\"let module of modules | async; let i = index\"\n                    >\n                        <div class=\"w-12 p-2 flex items-center justify-center\">\n                            <i\n                                *ngIf=\"module.system\"\n                                binding\n                                [(model)]=\"module.connected\"\n                                [sys]=\"module.system.id\"\n                                [mod]=\"module\"\n                                bind=\"connected\"\n                            ></i>\n                            <div\n                                class=\"h-2 w-2 rounded-full bg-black\"\n                                [class.bg-error]=\"\n                                    module.running && !module.connected\n                                \"\n                                [class.bg-success]=\"\n                                    module.running && module.connected\n                                \"\n                            ></div>\n                        </div>\n                        <div\n                            flex\n                            class=\"flex-1 p-2 underline\"\n                            i18n=\"@@nameLabel\"\n                        >\n                            <a [routerLink]=\"['/modules', module.id]\">\n                                {{ module.custom_name || module.name }}\n                            </a>\n                        </div>\n                        <div class=\"w-24 p-2\">\n                            <button\n                                mat-icon-button\n                                matTooltip=\"View Systems\"\n                                [matMenuTriggerFor]=\"menu\"\n                                (click)=\"loadSystems(module)\"\n                            >\n                                <app-icon className=\"backoffice-eye\"></app-icon>\n                            </button>\n                            <mat-menu #menu=\"matMenu\">\n                                <div\n                                    class=\"flex items-center justify-center px-2 pb-2 opacity-70 border-b border-gray-200 text-sm\"\n                                >\n                                    {{ systems[module.id]?.length }} System(s)\n                                </div>\n                                <div\n                                    *ngIf=\"loading_systems\"\n                                    class=\"flex items-center space-x-2 p-2 text-sm\"\n                                >\n                                    <mat-spinner [diameter]=\"32\"></mat-spinner>\n                                    <span>Loading systems...</span>\n                                </div>\n                                <a\n                                    mat-menu-item\n                                    *ngFor=\"\n                                        let system of systems[module.id] || []\n                                    \"\n                                    class=\"leading-tight\"\n                                    [routerLink]=\"['/systems', system.id]\"\n                                >\n                                    <div\n                                        class=\"flex flex-col justify-center px-2 h-full\"\n                                    >\n                                        <div class=\"text-base\">\n                                            {{\n                                                system.display_name ||\n                                                    system.name\n                                            }}\n                                        </div>\n                                        <div class=\"text-xs opacity-60\">\n                                            {{ system.id }}\n                                        </div>\n                                    </div>\n                                </a>\n                            </mat-menu>\n                            <button\n                                mat-icon-button\n                                (click)=\"removeModule(module)\"\n                            >\n                                <app-icon\n                                    className=\"backoffice-trash\"\n                                ></app-icon>\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </section>\n        <ng-template #load_state>\n            <div class=\"flex flex-col items-center p-8 mx-auto\">\n                <mat-spinner [diameter]=\"48\" class=\"mb-4\"></mat-spinner>\n                <p>Loading modules...</p>\n            </div>\n        </ng-template>\n        <ng-template #empty_state>\n            <div class=\"flex flex-col items-center p-8 mx-auto\">\n                <p>No modules with driver</p>\n            </div>\n        </ng-template>\n    `,\n    styles: [\n        `\n            :host {\n                padding: 1rem;\n                height: 100%;\n                width: 100%;\n            }\n\n            [role='table'] > div {\n                width: 100%;\n                min-width: 28rem;\n            }\n        `,\n    ],\n})\nexport class DriverModulesComponent extends BaseClass {\n    public loading_systems = false;\n    /** Subject holding the value of the search */\n    public readonly filter$ = new BehaviorSubject<string>('');\n    /** Whether systems are being loaded */\n    public readonly loading = this._service.loading;\n    /** Currently active driver */\n    public readonly item = this._service.item;\n    /** List of systems associated with modules */\n    public readonly systems: HashMap<PlaceSystem[]> = {};\n    /** Whether systems are being loaded */\n    /** List of modules */\n    public readonly modules = combineLatest([\n        this.filter$,\n        this._service.modules,\n    ]).pipe(\n        map((details) => {\n            const [filters, modules] = details;\n            const search = filters.toLowerCase();\n            return filters\n                ? modules.filter(\n                      (mod) =>\n                          mod.name.toLowerCase().includes(search) ||\n                          mod.custom_name.toLowerCase().includes(search)\n                  )\n                : modules;\n        })\n    );\n\n    public readonly removeModule = (d) => this._service.removeModule(d);\n\n    constructor(private _service: DriverStateService) {\n        super();\n    }\n\n    public async loadSystems(mod: PlaceModule) {\n        this.loading_systems = true;\n        const systems = await querySystems({ module_id: mod.id })\n            .pipe(map(({ data }) => data))\n            .toPromise();\n        this.systems[mod.id] = systems || [];\n        this.loading_systems = false;\n    }\n}\n","import { Routes } from '@angular/router';\n\nimport { DriversComponent } from './drivers.component';\nimport { DriverAboutComponent } from './driver-about.component';\nimport { DriverModulesComponent } from './driver-devices.component';\nimport { ExtensionOutletComponent } from '../ui/extension-outlet.component';\nimport { SettingsHistoryViewComponent } from '../ui/settings-history-view.component';\n\nexport const ROUTES: Routes = [\n    {\n        path: ':id',\n        component: DriversComponent,\n        children: [\n            { path: 'about', component: DriverAboutComponent },\n            { path: 'modules', component: DriverModulesComponent },\n            { path: 'extend/:id', component: ExtensionOutletComponent },\n            { path: 'history', component: SettingsHistoryViewComponent },\n            { path: '**', redirectTo: 'about' },\n        ],\n    },\n    { path: '**', redirectTo: '-' },\n];\n","import { NgModule } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport { RouterModule } from '@angular/router';\n\nimport { ROUTES } from './drivers.routes';\n\nimport { DriversComponent } from './drivers.component';\nimport { DriverAboutComponent } from './driver-about.component';\nimport { DriverModulesComponent } from './driver-devices.component';\nimport { SharedContentModule } from 'apps/backoffice/src/app/ui/ui.module';\n\n@NgModule({\n    declarations: [\n        DriversComponent,\n        DriverAboutComponent,\n        DriverModulesComponent,\n    ],\n    imports: [\n        CommonModule,\n        FormsModule,\n        RouterModule.forChild(ROUTES),\n        SharedContentModule,\n    ],\n})\nexport class AppDriversModule {}\n"],"sourceRoot":"webpack:///","file":"18.29d6b181dddd599a.js"}