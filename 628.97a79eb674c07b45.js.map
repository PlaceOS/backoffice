{"version":3,"mappings":"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","names":["TriggersComponent","BaseClass","constructor","_service","_dialog","super","this","show_options","extensions","extensionsForItem","active_item","name","updateTabList","tab_list","id","icon","class","count","instance_count","concat","ngOnInit","subscription","item","subscribe","loadValues","listTriggerInstances","toPromise","length","i0","selectors","TriggerStateService","pipe","switchMap","PlaceTrigger","of","shareReplay","editCondition","condition","template","ref","open","TriggerConditionModalComponent","width","height","data","trigger","JSON","parse","stringify","undefined","system","result","Promise","race","componentInstance","event","first","_","reason","afterClosed","o","replaceItem","metadata","editAction","action","TriggerActionModalComponent","reorderAction","type","fst","snd","details","openConfirmModal","title","content","list","actions","functions","mailers","moveItemInArray","loading","resp","updateTrigger","Object","toJSON","catch","notifyError","response","message","notifySuccess","removeCondition","conditions","comparisons","time_dependents","index","findIndex","i","splice","err","close","removeAction","emails","removeTriggerFromSystem","removeSystemTrigger","responseText","factory","ctx_r13","oxw","ctx_r15","ctx_r17","ctx_r19","ctx_r26","ctx_r28","ctx_r31","ctx_r33","action_r29","ctx_r34","$event","ctx_r36","ctx_r7","ROUTES","path","component","children","querySystems","q","map","c","template_system","a","confirmReorder","previousIndex","currentIndex","TriggerAboutComponent","$localize","i18n_22","ctx","instances","s","TriggerInstancesComponent","ExtensionOutletComponent","redirectTo","AppTriggersModule","CommonModule","FormsModule","RouterModule","SharedContentModule","DragDropModule"],"sources":["./apps/backoffice/src/app/triggers/triggers.component.ts","./apps/backoffice/src/app/triggers/trigger-state.service.ts","./apps/backoffice/src/app/triggers/trigger-about.component.ts","./apps/backoffice/src/app/triggers/trigger-instances.component.ts","./apps/backoffice/src/app/triggers/triggers.routes.ts","./apps/backoffice/src/app/triggers/triggers.module.ts"],"sourcesContent":["import { Component } from '@angular/core';\nimport { MatDialog } from '@angular/material/dialog';\nimport { listTriggerInstances, PlaceTrigger } from '@placeos/ts-client';\nimport { extensionsForItem } from '../common/api';\n\nimport { BaseClass } from '../common/base.class';\nimport { ActiveItemService } from '../common/item.service';\n\n@Component({\n    selector: 'app-triggers',\n    template: `\n        <div class=\"flex-1 flex-col sm:flex-row flex h-full w-full relative\">\n            <sidebar\n                heading=\"Triggers\"\n                name=\"triggers\"\n                class=\"absolute top-0 left-0 h-12 w-full sm:h-full sm:static\"\n            ></sidebar>\n            <item-display\n                name=\"trigger\"\n                route=\"triggers\"\n                [tabs]=\"tab_list\"\n                class=\"flex-1 relative mt-12 sm:mt-0 w-full sm:w-1/2\"\n            ></item-display>\n        </div>\n    `,\n    styles: [\n        `\n            sidebar {\n                transition: height 300ms;\n            }\n            @media screen and (min-width: 640px) {\n                sidebar {\n                    width: 20em !important;\n                }\n            }\n        `,\n    ],\n})\nexport class TriggersComponent extends BaseClass {\n    /** Number of system triggers */\n    public instance_count: number;\n\n    public readonly name = 'triggers';\n\n    public readonly show_options = this._service.show_options;\n\n    public tab_list = [];\n\n    public get extensions() {\n        return extensionsForItem(this._service.active_item, this.name);\n    }\n\n    public updateTabList() {\n        this.tab_list = [\n            {\n                id: 'about',\n                name: 'About',\n                icon: { class: 'backoffice-info-with-circle' },\n            },\n            {\n                id: 'instances',\n                name: 'Instances',\n                count: this.instance_count,\n                icon: { class: 'backoffice-documents' },\n            },\n        ].concat(this.extensions);\n    }\n\n    constructor(\n        protected _service: ActiveItemService,\n        private _dialog: MatDialog\n    ) {\n        super();\n    }\n\n    public ngOnInit(): void {\n        this.subscription(\n            'item',\n            this._service.item.subscribe((item) => {\n                this.loadValues(item as any);\n            })\n        );\n        this.updateTabList();\n    }\n\n    protected async loadValues(item: PlaceTrigger) {\n        if (!item) return;\n        // Get trigger count\n        this.instance_count = (\n            await listTriggerInstances(item.id).toPromise()\n        ).length;\n        this.updateTabList();\n    }\n}\n","import { moveItemInArray } from '@angular/cdk/drag-drop';\nimport { Injectable } from '@angular/core';\nimport { MatDialog } from '@angular/material/dialog';\nimport {\n    PlaceSystem,\n    PlaceTrigger,\n    listTriggerInstances,\n    removeSystemTrigger,\n    TriggerComparison,\n    TriggerFunction,\n    TriggerMailer,\n    TriggerTimeCondition,\n    updateTrigger,\n} from '@placeos/ts-client';\nimport { Observable, of } from 'rxjs';\nimport { first, shareReplay, switchMap } from 'rxjs/operators';\nimport { openConfirmModal } from '../common/general';\n\nimport { ActiveItemService } from '../common/item.service';\nimport { notifyError, notifySuccess } from '../common/notifications';\nimport { DialogEvent } from '../common/types';\nimport {\n    TriggerActionModalComponent,\n    TriggerActionModalData,\n} from '../overlays/trigger-action-modal/trigger-action-modal.component';\nimport {\n    TriggerConditionData,\n    TriggerConditionModalComponent,\n} from '../overlays/trigger-condition-modal/trigger-condition-modal.component';\n\n@Injectable({\n    providedIn: 'root',\n})\nexport class TriggerStateService {\n    public readonly item: Observable<PlaceTrigger> = this._service.item as any;\n\n    public readonly instances: Observable<PlaceTrigger[]> = this.item.pipe(\n        switchMap((item) => {\n            if (!(item instanceof PlaceTrigger)) return of([]);\n            return listTriggerInstances(item.id);\n        }),\n        shareReplay(1)\n    );\n\n    public get active_item(): PlaceTrigger {\n        return this._service.active_item as any;\n    }\n\n    constructor(\n        private _service: ActiveItemService,\n        private _dialog: MatDialog\n    ) {}\n\n    /**\n     * Add new condition to trigger\n     */\n    public async editCondition(\n        condition: TriggerComparison | TriggerTimeCondition = null,\n        template: PlaceSystem\n    ) {\n        if (!template) return;\n        const ref = this._dialog.open<\n            TriggerConditionModalComponent,\n            TriggerConditionData\n        >(TriggerConditionModalComponent, {\n            width: 'auto',\n            height: 'auto',\n            data: {\n                trigger: this.active_item,\n                condition: condition\n                    ? JSON.parse(JSON.stringify(condition))\n                    : undefined,\n                system: template,\n            },\n        });\n        const result: DialogEvent | null = (await Promise.race([\n            ref.componentInstance.event\n                .pipe(first((_) => _.reason === 'done'))\n                .toPromise(),\n            ref.afterClosed().toPromise(),\n        ])) as any;\n        if (!result?.reason) return;\n        this._service.replaceItem(result.metadata.trigger);\n    }\n\n    /**\n     * Edit existing action on active trigger\n     * @param action Action to edit\n     */\n    public async editAction(\n        action: TriggerFunction | TriggerMailer = null,\n        template: PlaceSystem\n    ) {\n        if (!template) return;\n        const ref = this._dialog.open<\n            TriggerActionModalComponent,\n            TriggerActionModalData\n        >(TriggerActionModalComponent, {\n            data: {\n                trigger: this.active_item,\n                action,\n                system: template,\n            },\n        });\n        const result: DialogEvent | null = (await Promise.race([\n            ref.componentInstance.event\n                .pipe(first((_) => _.reason === 'done'))\n                .toPromise(),\n            ref.afterClosed().toPromise(),\n        ])) as any;\n        if (!result?.reason) return;\n        this._service.replaceItem(result.metadata.trigger);\n    }\n\n    /**\n     * Re-order action for active trigger\n     * @param type Type of action to reorder\n     * @param event Drop event details\n     */\n    public async reorderAction(\n        type: 'function' | 'mailer',\n        fst: number,\n        snd: number\n    ): Promise<void> {\n        const details = await openConfirmModal(\n            {\n                title: `Reoreder trigger ${type} action`,\n                content: `Are you sure you want remove this trigger condition?<br>All systems using this trigger will be updated <strong>immediately</strong>.`,\n                icon: { type: 'icon', class: 'backoffice-trash' },\n            },\n            this._dialog\n        );\n        if (!details) return;\n        const list: any[] = [\n            ...(type === 'function'\n                ? this.active_item.actions.functions\n                : this.active_item.actions.mailers),\n        ];\n        moveItemInArray(list, fst, snd);\n        const actions = {\n            functions:\n                type === 'function' ? list : this.active_item.actions.functions,\n            mailers:\n                type === 'function' ? this.active_item.actions.mailers : list,\n        };\n        details.loading('Re-ordering triggger actions...');\n        const resp = await updateTrigger(this.active_item.id, {\n            ...this.active_item.toJSON(),\n            actions,\n        })\n            .toPromise()\n            .catch((_) => _);\n        if (!(resp instanceof PlaceTrigger))\n            return notifyError(\n                `Error re-ordered trigger ${type} action. Error: ${JSON.stringify(\n                    resp.response || resp.message || resp\n                )}`\n            );\n        this._service.replaceItem(resp);\n        notifySuccess(`Successfully re-ordered trigger ${type} action.`);\n    }\n\n    public async removeCondition(\n        condition: TriggerComparison | TriggerTimeCondition\n    ) {\n        const details = await openConfirmModal(\n            {\n                title: `Remove trigger condition`,\n                content: `Are you sure you want remove this trigger condition?<br>All systems using this trigger will be updated <strong>immediately</strong>.`,\n                icon: { type: 'icon', class: 'backoffice-trash' },\n            },\n            this._dialog\n        );\n        if (!details?.reason) return;\n        details.loading('Removing trigger condition...');\n        const item = this.active_item;\n        const conditions = {\n            comparisons: [...item.conditions.comparisons],\n            time_dependents: [...item.conditions.time_dependents],\n        };\n        const index = ((condition as TriggerTimeCondition).type\n            ? item.conditions.time_dependents\n            : item.conditions.comparisons\n        ).findIndex((i) => JSON.stringify(i) === JSON.stringify(condition));\n        conditions.time_dependents.splice(index, 1);\n        ((condition as TriggerTimeCondition).type\n            ? conditions.time_dependents\n            : conditions.comparisons\n        ).splice(index, 1);\n        const resp = await updateTrigger(item.id, {\n            ...item.toJSON(),\n            conditions,\n        })\n            .toPromise()\n            .catch((err) => err);\n        details.close();\n        if (!(resp instanceof PlaceTrigger)) {\n            return notifyError(\n                `Error removing trigger condition. Error: ${JSON.stringify(\n                    resp.response || resp.message || resp\n                )}`\n            );\n        }\n        this._service.replaceItem(resp);\n        notifySuccess('Successfully removed trigger condition.');\n    }\n\n    public async removeAction(action: TriggerFunction | TriggerMailer) {\n        const details = await openConfirmModal(\n            {\n                title: `Remove trigger action`,\n                content: `Are you sure you want remove this trigger action?<br>All systems using this trigger will be updated <strong>immediately</strong>.`,\n                icon: { type: 'icon', class: 'backoffice-trash' },\n            },\n            this._dialog\n        );\n        if (!details?.reason) return;\n        details.loading('Removing trigger action...');\n        const item = this.active_item;\n        const actions = {\n            functions: [...item.actions.functions],\n            mailers: [...item.actions.mailers],\n        };\n        const index = ((action as TriggerMailer).emails\n            ? item.actions.mailers\n            : item.actions.functions\n        ).findIndex((i) => JSON.stringify(i) === JSON.stringify(action));\n        ((action as TriggerMailer).emails\n            ? actions.mailers\n            : actions.functions\n        ).splice(index, 1);\n        const resp = await updateTrigger(item.id, { ...item.toJSON(), actions })\n            .toPromise()\n            .catch((err) => err);\n        details.close();\n        if (!(resp instanceof PlaceTrigger)) {\n            return notifyError(\n                `Error removing trigger action. Error: ${JSON.stringify(\n                    resp.response || resp.message || resp\n                )}`\n            );\n        }\n        this._service.replaceItem(resp);\n        notifySuccess('Successfully removed trigger action.');\n    }\n\n    public async removeTriggerFromSystem(system: PlaceSystem) {\n        const details = await openConfirmModal(\n            {\n                title: `Remove trigger from system`,\n                content: `Are you sure you want remove this trigger from ${system.name}?<br>The system will be updated <strong>immediately</strong>.`,\n                icon: { type: 'icon', class: 'backoffice-trash' },\n            },\n            this._dialog\n        );\n        if (!details?.reason) return;\n        details.loading('Removing trigger from system...');\n        const err = await removeSystemTrigger(system.id, this.active_item.id)\n            .toPromise()\n            .catch((_) => _);\n        details.close();\n        if (err)\n            return notifyError(\n                `Error removing trigger from system. Error: ${\n                    err.responseText || err.message || err\n                }`\n            );\n        notifySuccess('Successfully removed trigger from system.');\n    }\n}\n","import { Component } from '@angular/core';\nimport { CdkDragDrop } from '@angular/cdk/drag-drop';\nimport {\n    PlaceTrigger,\n    PlaceSystem,\n    TriggerComparison,\n    TriggerTimeCondition,\n    TriggerFunction,\n    TriggerMailer,\n    querySystems,\n} from '@placeos/ts-client';\nimport { map } from 'rxjs/operators';\n\nimport { BaseClass } from 'apps/backoffice/src/app/common/base.class';\nimport { TriggerStateService } from './trigger-state.service';\n\n@Component({\n    selector: 'trigger-about',\n    template: `\n        <section class=\"space-y-2\">\n            <div class=\"flex items-center space-x-2\" *ngIf=\"item.created_at\">\n                <label i18n=\"@@triggerCreatedAtLabel\">Created:</label>\n                <div class=\"value\">{{ item.created_at * 1000 | dateFrom }}</div>\n            </div>\n            <div class=\"flex items-center space-x-2\" *ngIf=\"item.updated_at\">\n                <label i18n=\"@triggerUpdatedAtLabel\">Updated:</label>\n                <div class=\"value\">{{ item.updated_at * 1000 | dateFrom }}</div>\n            </div>\n        </section>\n        <hr class=\"my-4\" />\n        <div class=\"flex items-center space-x-2\">\n            <label\n                for=\"driver\"\n                class=\"whitespace-nowrap\"\n                matTooltip=\"System to use for available status variables and function calls\"\n                i18n=\"@@triggerTemplateSystemLabel\"\n                >Template System:\n            </label>\n            <item-search-field\n                class=\"h-12\"\n                name=\"system\"\n                [query_fn]=\"query_fn\"\n                [(ngModel)]=\"template_system\"\n            ></item-search-field>\n        </div>\n        <header class=\"flex items-center my-4\">\n            <button\n                mat-icon-button\n                [disabled]=\"!template_system\"\n                (click)=\"editCondition()\"\n            >\n                <app-icon className=\"backoffice-plus\"></app-icon>\n            </button>\n            <div class=\"font-medium text-lg\" i18n=\"@@triggerConditionsHeader\">\n                Conditions\n            </div>\n        </header>\n        <section\n            role=\"table\"\n            *ngIf=\"\n                comparisons.length || time_dependents.length;\n                else no_conditions\n            \"\n        >\n            <div\n                table-head\n                i18n=\"@@triggerComparisonLabel\"\n                *ngIf=\"comparisons.length\"\n            >\n                <div class=\"flex-1 p-2\">Variable Comparison Condtions</div>\n            </div>\n            <div table-body>\n                <div table-row *ngFor=\"let comparison of comparisons\">\n                    <div class=\"w-12\"></div>\n                    <div class=\"flex-1 p-2\">\n                        {{ comparison.left | json }} {{ comparison.operator }}\n                        {{ comparison.right | json }}\n                    </div>\n                    <div class=\"w-24 flex items-center justify-center\">\n                        <button\n                            mat-icon-button\n                            [disabled]=\"!template_system\"\n                            (click)=\"editCondition(comparison)\"\n                        >\n                            <app-icon\n                                [icon]=\"{ class: 'backoffice-edit' }\"\n                            ></app-icon>\n                        </button>\n                        <button\n                            mat-icon-button\n                            (click)=\"removeCondition(comparison)\"\n                        >\n                            <app-icon\n                                [icon]=\"{ class: 'backoffice-trash' }\"\n                            ></app-icon>\n                        </button>\n                    </div>\n                </div>\n            </div>\n            <div\n                table-head\n                i18n=\"@@triggerTimeLabel\"\n                *ngIf=\"time_dependents.length\"\n            >\n                <div class=\"flex-1 p-2\">Time Dependent Conditions</div>\n            </div>\n            <div table-body>\n                <div table-row *ngFor=\"let time of time_dependents\">\n                    <div class=\"w-12\"></div>\n                    <div class=\"flex-1 p-2\">\n                        {{ time.type === 'at' ? 'At time' : 'CRON' }}\n                        {{ time.type === 'at' ? time.time : time.cron }}\n                    </div>\n                    <div class=\"w-24 flex items-center justify-center\">\n                        <button\n                            mat-icon-button\n                            [disabled]=\"!template_system\"\n                            (click)=\"editCondition(time)\"\n                        >\n                            <app-icon className=\"backoffice-edit\"></app-icon>\n                        </button>\n                        <button mat-icon-button (click)=\"removeCondition(time)\">\n                            <app-icon className=\"backoffice-trash\"></app-icon>\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </section>\n        <header class=\"flex items-center space-x-2 my-4\">\n            <button\n                mat-icon-button\n                [disabled]=\"!template_system\"\n                (click)=\"editAction()\"\n            >\n                <app-icon className=\"backoffice-plus\"></app-icon>\n            </button>\n            <div class=\"font-medium text-lg\" i18n=\"@@triggerActionsHeader\">\n                Actions\n            </div>\n        </header>\n        <section\n            role=\"table\"\n            *ngIf=\"functions.length || mailers.length; else no_actions\"\n        >\n            <div\n                table-head\n                i18n=\"@@triggerFunctionsLabel\"\n                *ngIf=\"functions.length\"\n            >\n                <div class=\"flex-1 p-2\">Function Call Actions</div>\n            </div>\n            <div\n                table-body\n                cdkDropList\n                (cdkDropListDropped)=\"confirmReorder('function', $event)\"\n            >\n                <div table-row *ngFor=\"let action of functions\" cdkDrag>\n                    <div\n                        class=\"w-12 flex items-center justify-center\"\n                        cdkDragHandle\n                    >\n                        <app-icon\n                            [icon]=\"{ class: 'backoffice-select-arrows' }\"\n                        ></app-icon>\n                    </div>\n                    <div class=\"flex-1 p-2\">\n                        {{ action.mod }}, {{ action.method }}({{\n                            action.args | json\n                        }})\n                    </div>\n                    <div class=\"w-24 flex items-center justify-center\">\n                        <button\n                            mat-icon-button\n                            [disabled]=\"!template_system\"\n                            (click)=\"editAction(action)\"\n                        >\n                            <app-icon\n                                [icon]=\"{ class: 'backoffice-edit' }\"\n                            ></app-icon>\n                        </button>\n                        <button mat-icon-button (click)=\"removeAction(action)\">\n                            <app-icon\n                                [icon]=\"{ class: 'backoffice-trash' }\"\n                            ></app-icon>\n                        </button>\n                    </div>\n                    <div\n                        class=\"p-4 border-4 border-dashed border-black bg-gray-300\"\n                        *cdkDragPlaceholder\n                    ></div>\n                </div>\n            </div>\n            <div table-head i18n=\"@@triggerEmailsLabel\" *ngIf=\"mailers.length\">\n                <div class=\"flex-1 p-2\">Email Actions</div>\n            </div>\n            <div\n                table-body\n                cdkDropList\n                (cdkDropListDropped)=\"confirmReorder('mailer', $event)\"\n            >\n                <div table-row *ngFor=\"let action of mailers\" cdkDrag>\n                    <div\n                        class=\"w-12 flex items-center justify-center\"\n                        cdkDragHandle\n                    >\n                        <app-icon\n                            [icon]=\"{ class: 'backoffice-select-arrows' }\"\n                        ></app-icon>\n                    </div>\n                    <div class=\"flex-1 p-2\">\n                        <span\n                            [matTooltip]=\"action.emails | formatList\"\n                            i18n=\"@@emailCountDisplay\"\n                            >{{ action.emails.length }} { action.emails.length,\n                            plural, =1 { Address } other { Addresses } }</span\n                        >&nbsp; | Body Length: {{ action.content.length }}\n                    </div>\n                    <div class=\"w-24 flex items-center justify-center\">\n                        <button\n                            mat-icon-button\n                            [disabled]=\"!template_system\"\n                            (click)=\"editAction(action)\"\n                        >\n                            <app-icon\n                                [icon]=\"{ class: 'backoffice-edit' }\"\n                            ></app-icon>\n                        </button>\n                        <button mat-icon-button (click)=\"removeAction(action)\">\n                            <app-icon\n                                [icon]=\"{ class: 'backoffice-trash' }\"\n                            ></app-icon>\n                        </button>\n                    </div>\n                    <div\n                        class=\"p-4 border-4 border-dashed border-black bg-gray-300\"\n                        *cdkDragPlaceholder\n                    ></div>\n                </div>\n            </div>\n        </section>\n        <ng-template #no_conditions>\n            <div\n                class=\"flex flex-col items-center p-8\"\n                i18n=\"@@triggerConditionsEmpty\"\n            >\n                No condtions for trigger\n            </div>\n        </ng-template>\n        <ng-template #no_actions>\n            <div\n                class=\"flex flex-col items-center p-8\"\n                i18n=\"@@triggerActionsEmpty\"\n            >\n                No actions for trigger\n            </div>\n        </ng-template>\n    `,\n    styles: [\n        `\n            :host {\n                padding: 1rem;\n                height: 100%;\n                width: 100%;\n            }\n        `,\n    ],\n})\nexport class TriggerAboutComponent extends BaseClass {\n    /** System to use for conditions with systen variables and functions */\n    public template_system: PlaceSystem;\n    /** List of variable comparison trigger conditions */\n    public comparisons: TriggerComparison[] = [];\n    /** List of time dependent trigger conditions */\n    public time_dependents: TriggerTimeCondition[] = [];\n    /** List of function call trigger actions */\n    public functions: TriggerFunction[] = [];\n    /** List of email trigger actions */\n    public mailers: TriggerMailer[] = [];\n    /** Query function for systems */\n    public readonly query_fn = (_) =>\n        querySystems({ q: _ }).pipe(map((resp) => resp.data));\n\n    public readonly editCondition = (c?) =>\n        this._service.editCondition(c, this.template_system);\n    public readonly removeCondition = (c) => this._service.removeCondition(c);\n    public readonly editAction = (a?) =>\n        this._service.editAction(a, this.template_system);\n    public readonly removeAction = (a) => this._service.removeAction(a);\n\n    public get item(): PlaceTrigger {\n        return this._service.active_item as any;\n    }\n\n    constructor(private _service: TriggerStateService) {\n        super();\n    }\n\n    public ngOnInit(): void {\n        this.subscription(\n            'item',\n            this._service.item.subscribe((item) => {\n                if (this.item && this.item.conditions) {\n                    this.comparisons = this.item.conditions.comparisons || [];\n                    this.time_dependents =\n                        this.item.conditions.time_dependents || [];\n                    this.functions = this.item.actions.functions || [];\n                    this.mailers = this.item.actions.mailers || [];\n                }\n            })\n        );\n    }\n    /**\n     * Open confirmation modal for re-ordering action for active trigger\n     * @param type Type of action to reorder\n     * @param event Drop event details\n     */\n    public confirmReorder(\n        type: 'function' | 'mailer',\n        event: CdkDragDrop<any[]>\n    ): void {\n        if (event && event.previousIndex !== event.currentIndex) {\n            this._service.reorderAction(\n                type,\n                event.previousIndex,\n                event.currentIndex\n            );\n        }\n    }\n}\n","import { Component } from '@angular/core';\nimport { PlaceTrigger } from '@placeos/ts-client';\n\nimport { HashMap } from 'apps/backoffice/src/app/common/types';\n\nimport { TriggerStateService } from './trigger-state.service';\n\n@Component({\n    selector: 'trigger-systems',\n    template: `\n        <div role=\"table\" *ngIf=\"(instances | async)?.length; else empty_state\">\n            <div table-head>\n                <td class=\"w-12 h-10\"></td>\n                <td\n                    class=\"flex-1 h-10 flex items-center\"\n                    i18n=\"@@systemTableName\"\n                >\n                    Parent ID\n                </td>\n                <td\n                    class=\"w-32 h-10 flex items-center\"\n                    i18n=\"@@systemTableAdded\"\n                >\n                    Added\n                </td>\n                <td class=\"w-12 h-10\"></td>\n            </div>\n            <div table-body>\n                <div table-row *ngFor=\"let item of instances | async\">\n                    <div class=\"w-12 flex items-center justify-center\">\n                        <div\n                            class=\"h-2 w-2 rounded-full bg-black\"\n                            [class.active]=\"item.bookable\"\n                        ></div>\n                    </div>\n                    <div class=\"flex-1 p-2\">\n                        <a\n                            *ngIf=\"item.id\"\n                            class=\"underline\"\n                            [routerLink]=\"\n                                item.zone_id\n                                    ? ['/zones', item.zone_id]\n                                    : ['/systems', item.control_system_id]\n                            \"\n                            [matTooltip]=\"\n                                item.zone_id || item.control_system_id\n                            \"\n                        >\n                            {{\n                                item.name ||\n                                    item.zone_id ||\n                                    item.control_system_id\n                            }}\n                        </a>\n                    </div>\n                    <div class=\"w-32 p-2\">\n                        {{ +item.created_at * 1000 | dateFrom }}\n                    </div>\n                    <div class=\"w-12 flex items-center justify-center\">\n                        <button mat-icon-button (click)=\"deleteTrigger(item)\">\n                            <app-icon className=\"backoffice-trash\"></app-icon>\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <ng-template #empty_state>\n            <div class=\"flex flex-col items-center p-8\">\n                <div class=\"text\" i18n=\"@@systemTableEmpty\">\n                    No instances of trigger\n                </div>\n            </div>\n        </ng-template>\n    `,\n    styles: [\n        `\n            :host {\n                padding: 1rem;\n                height: 100%;\n                width: 100%;\n            }\n\n            .active {\n                background-color: var(--success) !important;\n            }\n        `,\n    ],\n})\nexport class TriggerInstancesComponent {\n    /** List of systems associated with the trigger */\n    public readonly instances = this._service.instances;\n    /** Map of systems ids to connected status */\n    public connected: HashMap<boolean> = {};\n\n    public readonly deleteTrigger = (s) =>\n        this._service.removeTriggerFromSystem(s);\n\n    public get item(): PlaceTrigger {\n        return this._service.active_item as any;\n    }\n\n    constructor(private _service: TriggerStateService) {}\n}\n","import { Routes } from '@angular/router';\n\nimport { TriggersComponent } from './triggers.component';\nimport { TriggerAboutComponent } from './trigger-about.component';\nimport { TriggerInstancesComponent } from './trigger-instances.component';\nimport { ExtensionOutletComponent } from '../ui/extension-outlet.component';\n\nexport const ROUTES: Routes = [\n    {\n        path: ':id',\n        component: TriggersComponent,\n        children: [\n            { path: 'about', component: TriggerAboutComponent },\n            { path: 'instances', component: TriggerInstancesComponent },\n            { path: 'extend/:id', component: ExtensionOutletComponent },\n            { path: '**', redirectTo: 'about' },\n        ],\n    },\n    { path: '**', redirectTo: '-' },\n];\n","import { NgModule } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport { RouterModule } from '@angular/router';\nimport { DragDropModule } from '@angular/cdk/drag-drop';\n\nimport { ROUTES } from './triggers.routes';\n\nimport { TriggersComponent } from './triggers.component';\nimport { TriggerAboutComponent } from './trigger-about.component';\nimport { TriggerInstancesComponent } from './trigger-instances.component';\nimport { SharedContentModule } from 'apps/backoffice/src/app/ui/ui.module';\n\n@NgModule({\n    declarations: [\n        TriggersComponent,\n        TriggerAboutComponent,\n        TriggerInstancesComponent,\n    ],\n    imports: [\n        CommonModule,\n        FormsModule,\n        RouterModule.forChild(ROUTES),\n        SharedContentModule,\n        DragDropModule,\n    ],\n})\nexport class AppTriggersModule {}\n"],"sourceRoot":"webpack:///","file":"628.97a79eb674c07b45.js"}